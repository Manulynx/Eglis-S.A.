
{% extends 'eglisapp/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<style>
/* Estilos para protecci√≥n contra env√≠os duplicados */
.btn[disabled], .btn:disabled {
    pointer-events: none !important;
    opacity: 0.6 !important;
    cursor: not-allowed !important;
}

form[data-enviando="true"] .btn[type="submit"] {
    pointer-events: none !important;
    opacity: 0.7 !important;
    cursor: not-allowed !important;
    position: relative;
}

form[data-enviando="true"] .btn[type="submit"]:after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.1);
    border-radius: inherit;
}

/* Prevenir doble click solo en el bot√≥n de env√≠o */
form[data-enviando="true"] .btn[type="submit"] {
    pointer-events: none !important;
    opacity: 0.7 !important;
    cursor: not-allowed !important;
}
</style>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-md-6">
            <!-- Card del formulario -->
            <div class="card bg-dark border-secondary">
                <div class="card-body">
                    <h4 class="text-white text-center mb-4">
                        <i class="fas fa-paper-plane text-primary me-2"></i>
                        Enviar
                    </h4>

                    <!-- Balance disponible -->
                    <div class="alert bg-dark text-white border {% if user.perfil.balance >= 0 %}border-info{% else %}border-danger{% endif %} mb-4">
                        <div class="text-center">
                            <h6 class="mb-2">Balance Disponible</h6>
                            <h3 class="mb-0 {% if user.perfil.balance >= 0 %}text-success{% else %}text-danger{% endif %}">
                                ${{ user.perfil.balance|floatformat:2 }} USD
                                {% if user.perfil.balance < 0 %}
                                    <small class="d-block text-warning" style="font-size: 0.7rem;">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Balance negativo
                                    </small>
                                {% endif %}
                            </h3>
                        </div>
                    </div>

                    <form method="post" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}

                        {% if is_admin_user %}
                        <div class="mb-3">
                            <label for="usuario_asignado" class="form-label text-white">Crear a nombre de</label>
                            <select class="form-select bg-dark text-white border-secondary"
                                    id="usuario_asignado"
                                    name="usuario_asignado">
                                <option value="">Elegir</option>
                            </select>
                            <small class="form-text text-white fw-semibold">El pago se asignar√° al usuario seleccionado.</small>
                        </div>
                        {% endif %}
                        
                        <!-- Tipo de Pago -->
                        <div class="mb-3">
                            <label class="form-label text-white">
                                Tipo de Pago *
                            </label>
                            <div class="mt-2">
                                <div class="form-check mb-2">
                                    <input class="form-check-input tipo-pago-check" type="checkbox" 
                                           id="tipo_pago_transferencia" name="tipo_pago" value="transferencia">
                                    <label class="form-check-label text-white" for="tipo_pago_transferencia">
                                        <i class="fas fa-university me-2"></i>Transferencia
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input tipo-pago-check" type="checkbox" 
                                           id="tipo_pago_efectivo" name="tipo_pago" value="efectivo">
                                    <label class="form-check-label text-white" for="tipo_pago_efectivo">
                                        <i class="fas fa-money-bills me-2"></i>Efectivo
                                    </label>
                                </div>
                            </div>
                            {% if form.tipo_pago.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.tipo_pago.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Campos para Transferencia -->
                        <div id="campos_transferencia" style="display: none;">
                            <!-- Campo oculto para destinatario en transferencias -->
                            <input type="hidden" id="destinatario_transferencia" name="destinatario" value="">
                            
                            <div class="mb-3">
                                <label for="{{ form.tipo_moneda.id_for_label }}" class="form-label text-white">
                                    Moneda *
                                </label>
                                <select class="form-select bg-dark text-white border-secondary" 
                                        id="{{ form.tipo_moneda.id_for_label }}" 
                                        name="tipo_moneda">
                                    <option value="">Seleccionar moneda...</option>
                                    <!-- Las opciones se cargan din√°micamente con JavaScript -->
                                </select>
                                {% if form.tipo_moneda.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.tipo_moneda.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.cantidad.id_for_label }}" class="form-label text-white">
                                    Cantidad *
                                </label>
                                {{ form.cantidad }}
                                {% if form.cantidad.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.cantidad.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.tarjeta.id_for_label }}" class="form-label text-white">
                                    Tarjeta *
                                </label>
                                {{ form.tarjeta }}
                                {% if form.tarjeta.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.tarjeta.errors.0 }}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">Ingrese el n√∫mero de tarjeta (16 d√≠gitos)</small>
                            </div>

                            <div class="mb-3">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="check_comprobante_pago">
                                    <label class="form-check-label text-white" for="check_comprobante_pago">
                                        <i class="fas fa-receipt me-2"></i>Adjuntar comprobante de pago
                                    </label>
                                </div>
                                <div id="campo_comprobante_pago" style="display: none;">
                                    <label for="{{ form.comprobante_pago.id_for_label }}" class="form-label text-white">Comprobante de Pago</label>
                                    {{ form.comprobante_pago }}
                                    {% if form.comprobante_pago.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.comprobante_pago.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">Suba una imagen del comprobante de pago</small>
                                </div>
                            </div>

                            <!-- Campo de Observaciones para Transferencia -->
                            <div class="mb-3">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="check_observaciones_transferencia">
                                    <label class="form-check-label text-white" for="check_observaciones_transferencia">
                                        <i class="fas fa-comment me-2"></i>Agregar observaciones
                                    </label>
                                </div>
                                <div id="campo_observaciones_transferencia" style="display: none;">
                                    <label for="{{ form.observaciones.id_for_label }}" class="form-label text-white">
                                        Observaciones
                                    </label>
                                    {{ form.observaciones }}
                                    {% if form.observaciones.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.observaciones.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">Agregue comentarios adicionales sobre el pago</small>
                                </div>
                            </div>
                        </div>

                        <!-- Campos para Efectivo -->
                        <div id="campos_efectivo" style="display: none;">
                            <div class="mb-3">
                                <label for="{{ form.tipo_moneda.id_for_label }}_efectivo" class="form-label text-white">
                                    Moneda *
                                </label>
                                <select class="form-select bg-dark text-white border-secondary" 
                                        id="{{ form.tipo_moneda.id_for_label }}_efectivo" 
                                        name="tipo_moneda_efectivo">
                                    <option value="">Seleccionar moneda...</option>
                                    <!-- Las opciones se cargan din√°micamente con JavaScript -->
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.cantidad.id_for_label }}_efectivo" class="form-label text-white">
                                    Cantidad *
                                </label>
                                <input type="number" class="form-control bg-dark text-white border-secondary" 
                                       id="{{ form.cantidad.id_for_label }}_efectivo" 
                                       name="cantidad_efectivo" step="0.01" placeholder="0.00">
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.destinatario.id_for_label }}_efectivo" class="form-label text-white">
                                    Destinatario *
                                </label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" 
                                       id="{{ form.destinatario.id_for_label }}_efectivo" 
                                       name="destinatario_efectivo" placeholder="Nombre del destinatario">
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.telefono.id_for_label }}_efectivo" class="form-label text-white">
                                    Tel√©fono *
                                </label>
                                <input type="tel" class="form-control bg-dark text-white border-secondary" 
                                       id="{{ form.telefono.id_for_label }}_efectivo" 
                                       name="telefono_efectivo" placeholder="+1234567890">
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.direccion.id_for_label }}_efectivo" class="form-label text-white">
                                    Direcci√≥n *
                                </label>
                                <textarea class="form-control bg-dark text-white border-secondary" 
                                          id="{{ form.direccion.id_for_label }}_efectivo" 
                                          name="direccion_efectivo" rows="3" 
                                          placeholder="Direcci√≥n completa del destinatario"></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.carnet_identidad.id_for_label }}_efectivo" class="form-label text-white">
                                    C√©dula/Documento
                                </label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" 
                                       id="{{ form.carnet_identidad.id_for_label }}_efectivo" 
                                       name="carnet_identidad_efectivo" 
                                       placeholder="N√∫mero de c√©dula o documento de identidad">
                            </div>

                            <!-- Campo de Observaciones para Efectivo -->
                            <div class="mb-3">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="check_observaciones_efectivo">
                                    <label class="form-check-label text-white" for="check_observaciones_efectivo">
                                        <i class="fas fa-comment me-2"></i>Agregar observaciones
                                    </label>
                                </div>
                                <div id="campo_observaciones_efectivo" style="display: none;">
                                    <label for="observaciones_efectivo" class="form-label text-white">
                                        Observaciones
                                    </label>
                                    <textarea class="form-control bg-dark text-white border-secondary" 
                                              id="observaciones_efectivo" 
                                              name="observaciones_efectivo" rows="3" 
                                              placeholder="Agregue comentarios adicionales sobre el pago"></textarea>
                                    <small class="form-text text-muted">Agregue comentarios adicionales sobre el pago</small>
                                </div>
                            </div>
                        </div>

                        <!-- Mostrar errores de destinatario si existen -->
                        {% if form.destinatario.errors %}
                            <div class="alert alert-danger">
                                {{ form.destinatario.errors.0 }}
                            </div>
                        {% endif %}

                        <!-- Botones -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'remesas:registro_transacciones' %}" class="btn btn-outline-light">
                                Volver
                            </a>
                            <button type="submit" class="btn btn-primary">
                                Realizar Pago
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Script para pasar datos de Django a JavaScript -->
{{ user.id|json_script:"user-id" }}
<script type="application/json" id="monedas-data">{{ monedas_data_json|safe }}</script>
<script type="application/json" id="user-balance">{{ user.perfil.balance|floatformat:2 }}</script>

<!-- Estilos para checkboxes -->
<style>
.form-check-input {
    background-color: #1a1a1a;
    border: 1px solid #333;
    margin-right: 8px;
}

.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.form-check-input:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.form-check-label {
    cursor: pointer;
    user-select: none;
}

.form-check-label:hover {
    color: #87ceeb !important;
}

.tipo-pago-check:checked + .form-check-label {
    color: #87ceeb !important;
}

/* Estilos para input file */
input[type="file"].form-control {
    padding: 8px;
}

input[type="file"].form-control::file-selector-button {
    background-color: #0d6efd;
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 3px;
    margin-right: 10px;
    cursor: pointer;
}

input[type="file"].form-control::file-selector-button:hover {
    background-color: #0b5ed7;
}

/* Animaci√≥n para mostrar/ocultar campos */
.campo-animado {
    transition: all 0.3s ease-in-out;
    overflow: hidden;
}
</style>

<!-- JavaScript para validaci√≥n en tiempo real -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const usuarioAutenticadoId = JSON.parse(document.getElementById('user-id').textContent);

    function cargarUsuariosAsignados() {
        const select = document.getElementById('usuario_asignado');
        if (!select) return;

        fetch('/remesas/api/gestores/')
            .then(r => r.json())
            .then(data => {
                select.innerHTML = '<option value="">Elegir</option>';
                data.forEach(u => {
                    const option = document.createElement('option');
                    option.value = u.id;
                    option.textContent = u.nombre;
                    if (usuarioAutenticadoId && String(u.id) === String(usuarioAutenticadoId)) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                select.addEventListener('change', function() {
                    // Resetear selects de moneda
                    const selectTransferencia = document.getElementById('{{ form.tipo_moneda.id_for_label }}');
                    const selectEfectivo = document.getElementById('{{ form.tipo_moneda.id_for_label }}_efectivo');
                    if (selectTransferencia) selectTransferencia.innerHTML = '<option value="">Seleccionar moneda...</option>';
                    if (selectEfectivo) selectEfectivo.innerHTML = '<option value="">Seleccionar moneda...</option>';

                    // Recargar monedas para el tipo de pago activo
                    const activo = document.querySelector('.tipo-pago-check:checked');
                    if (activo) {
                        cargarMonedasPago(activo.value);
                    }
                });
            })
            .catch(err => console.error('Error cargando usuarios:', err));
    }

    cargarUsuariosAsignados();

    // Configurar checkboxes de tipo de pago para comportamiento exclusivo
    configurarTipoPago();
    
    // Validaci√≥n en tiempo real del formulario
    const form = document.querySelector('form');
    const cantidadInput = document.getElementById('{{ form.cantidad.id_for_label }}');
    const monedaSelect = document.getElementById('{{ form.tipo_moneda.id_for_label }}');
    const telefonoInput = document.getElementById('{{ form.telefono.id_for_label }}');
    
    // Obtener datos desde los scripts JSON
    const monedasDataElement = document.getElementById('monedas-data');
    const userBalanceElement = document.getElementById('user-balance');
    
    let monedasData = {};
    let balanceActual = 0;
    
    try {
        monedasData = JSON.parse(monedasDataElement.textContent);
    } catch (e) {
        console.error('Error parsing monedas data:', e);
        monedasData = {};
    }
    
    try {
        balanceActual = parseFloat(userBalanceElement.textContent) || 0;
    } catch (e) {
        console.error('Error parsing balance:', e);
        balanceActual = 0;
    }

    function cargarMonedasPago(tipoMoneda) {
        const usuarioAsignado = document.getElementById('usuario_asignado');
        const usuarioId = usuarioAsignado ? (usuarioAsignado.value || '') : '';

        // Construir URL con filtro
        let url = `/remesas/api/monedas/?tipo_moneda=${encodeURIComponent(tipoMoneda)}`;
        if (usuarioId) {
            url += `&usuario_id=${encodeURIComponent(usuarioId)}`;
        }
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                // Actualizar select de transferencia
                if (tipoMoneda === 'transferencia') {
                    const selectTransferencia = document.getElementById('{{ form.tipo_moneda.id_for_label }}');
                    if (selectTransferencia) {
                        selectTransferencia.innerHTML = '<option value="">Seleccionar moneda...</option>';
                        data.forEach(moneda => {
                            const option = document.createElement('option');
                            option.value = moneda.id;
                            option.textContent = moneda.nombre;
                            selectTransferencia.appendChild(option);
                        });
                    }
                }
                
                // Actualizar select de efectivo
                if (tipoMoneda === 'efectivo') {
                    const selectEfectivo = document.getElementById('{{ form.tipo_moneda.id_for_label }}_efectivo');
                    if (selectEfectivo) {
                        selectEfectivo.innerHTML = '<option value="">Seleccionar moneda...</option>';
                        data.forEach(moneda => {
                            const option = document.createElement('option');
                            option.value = moneda.id;
                            option.textContent = moneda.nombre;
                            selectEfectivo.appendChild(option);
                        });
                    }
                }
                
                // Actualizar datos de monedas para c√°lculos
                if (data.length > 0) {
                    // Convertir array a objeto por ID para f√°cil acceso
                    data.forEach(moneda => {
                        monedasData[moneda.id] = moneda;
                    });
                }
            })
            .catch(error => {
                console.error('Error cargando monedas:', error);
            });
    }

    function configurarTipoPago() {
        const tiposPagoChecks = document.querySelectorAll('.tipo-pago-check');
        const camposTransferencia = document.getElementById('campos_transferencia');
        const camposEfectivo = document.getElementById('campos_efectivo');
        
        tiposPagoChecks.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    // Desmarcar todos los otros checkboxes de tipo de pago
                    tiposPagoChecks.forEach(function(otherCheckbox) {
                        if (otherCheckbox !== checkbox) {
                            otherCheckbox.checked = false;
                        }
                    });
                    
                    // Mostrar campos correspondientes
                    if (this.value === 'transferencia') {
                        camposTransferencia.style.display = 'block';
                        camposEfectivo.style.display = 'none';
                        limpiarCamposEfectivo();
                        
                        // Cargar monedas de transferencia
                        cargarMonedasPago('transferencia');
                        
                        // Establecer valor por defecto para destinatario en transferencias
                        const destinatarioTransferencia = document.getElementById('destinatario_transferencia');
                        if (destinatarioTransferencia) {
                            destinatarioTransferencia.value = 'Transferencia bancaria';
                        }
                    } else if (this.value === 'efectivo') {
                        camposEfectivo.style.display = 'block';
                        camposTransferencia.style.display = 'none';
                        limpiarCamposTransferencia();
                        
                        // Cargar monedas de efectivo
                        cargarMonedasPago('efectivo');
                    }
                } else {
                    // Si se desmarca, ocultar todos los campos
                    camposTransferencia.style.display = 'none';
                    camposEfectivo.style.display = 'none';
                }
            });
        });
        
        // Configurar checkbox del comprobante de pago
        configurarComprobantePago();
    }
    
    function configurarComprobantePago() {
        const checkComprobante = document.getElementById('check_comprobante_pago');
        const campoComprobante = document.getElementById('campo_comprobante_pago');
        const inputComprobante = document.getElementById('comprobante_pago');
        
        if (checkComprobante) {
            checkComprobante.addEventListener('change', function() {
                if (this.checked) {
                    campoComprobante.style.display = 'block';
                    campoComprobante.classList.add('campo-animado');
                } else {
                    campoComprobante.style.display = 'none';
                    if (inputComprobante) {
                        inputComprobante.value = '';
                    }
                }
            });
        }
        
        // Configurar checkbox de observaciones para transferencia
        const checkObservacionesTransferencia = document.getElementById('check_observaciones_transferencia');
        const campoObservacionesTransferencia = document.getElementById('campo_observaciones_transferencia');
        const inputObservacionesTransferencia = document.getElementById('{{ form.observaciones.id_for_label }}');
        
        if (checkObservacionesTransferencia) {
            checkObservacionesTransferencia.addEventListener('change', function() {
                if (this.checked) {
                    campoObservacionesTransferencia.style.display = 'block';
                    campoObservacionesTransferencia.classList.add('campo-animado');
                } else {
                    campoObservacionesTransferencia.style.display = 'none';
                    if (inputObservacionesTransferencia) {
                        inputObservacionesTransferencia.value = '';
                    }
                }
            });
        }
        
        // Configurar checkbox de observaciones para efectivo
        const checkObservacionesEfectivo = document.getElementById('check_observaciones_efectivo');
        const campoObservacionesEfectivo = document.getElementById('campo_observaciones_efectivo');
        const inputObservacionesEfectivo = document.getElementById('observaciones_efectivo');
        
        if (checkObservacionesEfectivo) {
            checkObservacionesEfectivo.addEventListener('change', function() {
                if (this.checked) {
                    campoObservacionesEfectivo.style.display = 'block';
                    campoObservacionesEfectivo.classList.add('campo-animado');
                } else {
                    campoObservacionesEfectivo.style.display = 'none';
                    if (inputObservacionesEfectivo) {
                        inputObservacionesEfectivo.value = '';
                    }
                }
            });
        }
    }
    
    function limpiarCamposTransferencia() {
        const campos = ['{{ form.tarjeta.id_for_label }}', '{{ form.comprobante_pago.id_for_label }}', 'destinatario_transferencia'];
        campos.forEach(function(campo) {
            const elemento = document.getElementById(campo);
            if (elemento) {
                elemento.value = '';
            }
        });
        
        // Resetear checkbox del comprobante
        const checkComprobante = document.getElementById('check_comprobante_pago');
        const campoComprobante = document.getElementById('campo_comprobante_pago');
        if (checkComprobante) {
            checkComprobante.checked = false;
        }
        if (campoComprobante) {
            campoComprobante.style.display = 'none';
        }
        
        // Resetear checkbox de observaciones para transferencia
        const checkObservacionesTransferencia = document.getElementById('check_observaciones_transferencia');
        const campoObservacionesTransferencia = document.getElementById('campo_observaciones_transferencia');
        const inputObservacionesTransferencia = document.getElementById('{{ form.observaciones.id_for_label }}');
        if (checkObservacionesTransferencia) {
            checkObservacionesTransferencia.checked = false;
        }
        if (campoObservacionesTransferencia) {
            campoObservacionesTransferencia.style.display = 'none';
        }
        if (inputObservacionesTransferencia) {
            inputObservacionesTransferencia.value = '';
        }
    }
    
    function limpiarCamposEfectivo() {
        const campos = [
            '{{ form.tipo_moneda.id_for_label }}_efectivo',
            '{{ form.cantidad.id_for_label }}_efectivo',
            '{{ form.destinatario.id_for_label }}_efectivo',
            '{{ form.telefono.id_for_label }}_efectivo',
            '{{ form.direccion.id_for_label }}_efectivo',
            '{{ form.carnet_identidad.id_for_label }}_efectivo',
            'observaciones_efectivo'
        ];
        campos.forEach(function(campo) {
            const elemento = document.getElementById(campo);
            if (elemento) {
                elemento.value = '';
            }
        });
        
        // Resetear checkbox de observaciones para efectivo
        const checkObservacionesEfectivo = document.getElementById('check_observaciones_efectivo');
        const campoObservacionesEfectivo = document.getElementById('campo_observaciones_efectivo');
        if (checkObservacionesEfectivo) {
            checkObservacionesEfectivo.checked = false;
        }
        if (campoObservacionesEfectivo) {
            campoObservacionesEfectivo.style.display = 'none';
        }
    }
    
    // Funci√≥n para obtener valor de moneda
    function obtenerValorMoneda(monedaId) {
        if (monedasData[monedaId]) {
            return monedasData[monedaId];
        }
        return { codigo: 'USD', valor_usuario: 1 };
    }
    
    // Funci√≥n para calcular y mostrar el monto en USD
    function calcularMontoUSD() {
        const tipoPagoSeleccionado = document.querySelector('.tipo-pago-check:checked');
        
        if (!tipoPagoSeleccionado) return;
        
        let cantidadInput, monedaSelect;
        
        if (tipoPagoSeleccionado.value === 'transferencia') {
            cantidadInput = document.getElementById('{{ form.cantidad.id_for_label }}');
            monedaSelect = document.getElementById('{{ form.tipo_moneda.id_for_label }}');
        } else if (tipoPagoSeleccionado.value === 'efectivo') {
            cantidadInput = document.getElementById('{{ form.cantidad.id_for_label }}_efectivo');
            monedaSelect = document.getElementById('{{ form.tipo_moneda.id_for_label }}_efectivo');
        }
        
        if (cantidadInput && monedaSelect) {
            const cantidad = parseFloat(cantidadInput.value) || 0;
            const monedaId = monedaSelect.value;
            
            if (cantidad > 0 && monedaId) {
                const moneda = obtenerValorMoneda(monedaId);
                let montoUSD = cantidad;
                
                if (moneda.codigo !== 'USD') {
                    montoUSD = cantidad / moneda.valor_usuario;
                }
                
                // Mostrar el c√°lculo
                let calculoDiv = document.getElementById('calculo-usd');
                if (!calculoDiv) {
                    calculoDiv = document.createElement('div');
                    calculoDiv.id = 'calculo-usd';
                    calculoDiv.className = 'alert alert-warning mt-2';
                    cantidadInput.parentNode.appendChild(calculoDiv);
                }
                
                const quedara = balanceActual - montoUSD;
                
                let mensaje = '<strong>Monto en USD:</strong> $' + montoUSD.toFixed(2) + ' USD<br>';
                mensaje += '<strong>Balance despu√©s del pago:</strong> $' + quedara.toFixed(2) + ' USD';
                
                if (quedara < 0) {
                    calculoDiv.className = 'alert alert-warning mt-2';
                    mensaje += '<br><span class="text-warning"><i class="fas fa-info-circle"></i> Balance resultar√° negativo</span>';
                } else {
                    calculoDiv.className = 'alert alert-info mt-2';
                }
                
                calculoDiv.innerHTML = mensaje;
            } else {
                const calculoDiv = document.getElementById('calculo-usd');
                if (calculoDiv) {
                    calculoDiv.remove();
                }
            }
        }
    }
    
    // Agregar listeners para recalcular (para ambos tipos de pago)
    function configurarCalculos() {
        // Listeners para transferencia
        const cantidadTransferencia = document.getElementById('{{ form.cantidad.id_for_label }}');
        const monedaTransferencia = document.getElementById('{{ form.tipo_moneda.id_for_label }}');
        
        if (cantidadTransferencia) {
            cantidadTransferencia.addEventListener('input', calcularMontoUSD);
        }
        if (monedaTransferencia) {
            monedaTransferencia.addEventListener('change', calcularMontoUSD);
        }
        
        // Listeners para efectivo
        const cantidadEfectivo = document.getElementById('{{ form.cantidad.id_for_label }}_efectivo');
        const monedaEfectivo = document.getElementById('{{ form.tipo_moneda.id_for_label }}_efectivo');
        
        if (cantidadEfectivo) {
            cantidadEfectivo.addEventListener('input', calcularMontoUSD);
        }
        if (monedaEfectivo) {
            monedaEfectivo.addEventListener('change', calcularMontoUSD);
        }
    }
    
    // Llamar a la configuraci√≥n de c√°lculos
    configurarCalculos();
    
    // Validar tel√©fono
    if (telefonoInput) {
        telefonoInput.addEventListener('input', function() {
            const digits = this.value.replace(/\D/g, '');
            if (this.value.length > 0 && digits.length < 7) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
                if (this.value.length > 0) {
                    this.classList.add('is-valid');
                }
            }
        });
    }
    
    // Configurar validaciones de cantidad para ambos tipos de pago
    function configurarValidacionesCantidad() {
        const cantidadTransferencia = document.getElementById('{{ form.cantidad.id_for_label }}');
        const cantidadEfectivo = document.getElementById('{{ form.cantidad.id_for_label }}_efectivo');
        
        [cantidadTransferencia, cantidadEfectivo].forEach(input => {
            if (input) {
                input.addEventListener('input', function() {
                    const value = parseFloat(this.value);
                    if (isNaN(value) || value <= 0) {
                        this.classList.add('is-invalid');
                    } else {
                        this.classList.remove('is-invalid');
                        this.classList.add('is-valid');
                    }
                });
            }
        });
    }
    
    configurarValidacionesCantidad();
    
    // Funci√≥n para formatear el campo de tarjeta
    function configurarFormatoTarjeta() {
        const tarjetaInput = document.getElementById('{{ form.tarjeta.id_for_label }}');
        
        if (tarjetaInput) {
            tarjetaInput.addEventListener('input', function(e) {
                // Obtener solo los n√∫meros del valor actual
                let value = e.target.value.replace(/\D/g, '');
                
                // Limitar a 16 d√≠gitos m√°ximo
                if (value.length > 16) {
                    value = value.substring(0, 16);
                }
                
                // Formatear en grupos de 4 separados por guiones
                let formattedValue = '';
                for (let i = 0; i < value.length; i += 4) {
                    if (i > 0) {
                        formattedValue += '-';
                    }
                    formattedValue += value.substring(i, i + 4);
                }
                
                // Actualizar el valor del input
                e.target.value = formattedValue;
                
                // Validaci√≥n visual
                if (value.length === 16) {
                    e.target.classList.remove('is-invalid');
                    e.target.classList.add('is-valid');
                } else if (value.length > 0) {
                    e.target.classList.add('is-invalid');
                    e.target.classList.remove('is-valid');
                } else {
                    e.target.classList.remove('is-invalid', 'is-valid');
                }
            });
            
            // Prevenir pegado de caracteres no num√©ricos
            tarjetaInput.addEventListener('paste', function(e) {
                e.preventDefault();
                
                // Obtener texto del portapapeles
                const paste = (e.clipboardData || window.clipboardData).getData('text');
                
                // Extraer solo los n√∫meros
                const numbers = paste.replace(/\D/g, '');
                
                // Limitar a 16 d√≠gitos
                const limitedNumbers = numbers.substring(0, 16);
                
                // Formatear y establecer el valor
                let formattedValue = '';
                for (let i = 0; i < limitedNumbers.length; i += 4) {
                    if (i > 0) {
                        formattedValue += '-';
                    }
                    formattedValue += limitedNumbers.substring(i, i + 4);
                }
                
                tarjetaInput.value = formattedValue;
                
                // Disparar evento input para activar validaciones
                tarjetaInput.dispatchEvent(new Event('input'));
            });
            
            // Prevenir escritura de caracteres no num√©ricos (excepto guiones)
            tarjetaInput.addEventListener('keypress', function(e) {
                // Permitir teclas de control (backspace, delete, tab, escape, enter)
                if ([8, 9, 27, 13, 46].includes(e.keyCode) ||
                    // Permitir Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                    (e.keyCode === 65 && e.ctrlKey === true) ||
                    (e.keyCode === 67 && e.ctrlKey === true) ||
                    (e.keyCode === 86 && e.ctrlKey === true) ||
                    (e.keyCode === 88 && e.ctrlKey === true)) {
                    return;
                }
                
                // Permitir solo n√∫meros
                if ((e.keyCode < 48 || e.keyCode > 57)) {
                    e.preventDefault();
                }
            });
        }
    }
    
    // Configurar formato de tarjeta (solo n√∫meros, agrupados en bloques de 4)
    configurarFormatoTarjeta();
    
    // Protecci√≥n simple contra doble click en el bot√≥n
    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            // Solo prevenir si ya est√° marcado como enviando
            if (form.dataset.enviando === 'true') {
                console.log('Click bloqueado: formulario ya est√° siendo enviado');
                e.preventDefault();
                return false;
            }
        });
    }
    
    // Calcular inicial si hay valores
    calcularMontoUSD();
    
    // Confirmaci√≥n antes de enviar
    form.addEventListener('submit', function(e) {
        console.log('=== EVENTO SUBMIT INICIADO ===');
        console.log('Estado actual enviando:', form.dataset.enviando);
        
        // PROTECCI√ìN CONTRA ENV√çOS DUPLICADOS
        if (form.dataset.enviando === 'true') {
            console.log('‚ùå Env√≠o bloqueado: formulario ya est√° siendo enviado');
            e.preventDefault();
            return false;
        }
        
        const tipoPagoSeleccionado = document.querySelector('.tipo-pago-check:checked');
        console.log('Tipo de pago seleccionado:', tipoPagoSeleccionado ? tipoPagoSeleccionado.value : 'ninguno');
        
        if (!tipoPagoSeleccionado) {
            console.log('‚ùå Error: No hay tipo de pago seleccionado');
            e.preventDefault();
            mostrarError('Por favor seleccione un tipo de pago');
            return false;
        }
        
        if (tipoPagoSeleccionado.value === 'transferencia') {
            // Validar campos de transferencia
            const cantidad = document.getElementById('{{ form.cantidad.id_for_label }}').value;
            const moneda = document.getElementById('{{ form.tipo_moneda.id_for_label }}').value;
            const tarjeta = document.getElementById('{{ form.tarjeta.id_for_label }}').value;
            
            console.log('Validando transferencia:', {cantidad, moneda, tarjeta});
            
            if (!cantidad || !moneda || !tarjeta) {
                console.log('‚ùå Error: Faltan campos obligatorios para transferencia');
                e.preventDefault();
                mostrarError('Por favor complete todos los campos obligatorios para transferencia');
                return false;
            }
            
            // Validar que la tarjeta tenga 16 d√≠gitos
            const tarjetaNumeros = tarjeta.replace(/\D/g, '');
            if (tarjetaNumeros.length !== 16) {
                console.log('‚ùå Error: Tarjeta no tiene 16 d√≠gitos');
                e.preventDefault();
                mostrarError('El n√∫mero de tarjeta debe tener exactamente 16 d√≠gitos');
                return false;
            }
        } else if (tipoPagoSeleccionado.value === 'efectivo') {
            // Validar campos de efectivo
            const cantidad = document.getElementById('{{ form.cantidad.id_for_label }}_efectivo').value;
            const moneda = document.getElementById('{{ form.tipo_moneda.id_for_label }}_efectivo').value;
            const destinatario = document.getElementById('{{ form.destinatario.id_for_label }}_efectivo').value;
            const telefono = document.getElementById('{{ form.telefono.id_for_label }}_efectivo').value;
            const direccion = document.getElementById('{{ form.direccion.id_for_label }}_efectivo').value;
            
            console.log('Validando efectivo:', {cantidad, moneda, destinatario, telefono, direccion});
            
            if (!cantidad || !moneda || !destinatario || !telefono || !direccion) {
                console.log('‚ùå Error: Faltan campos obligatorios para efectivo');
                e.preventDefault();
                mostrarError('Por favor complete todos los campos obligatorios para efectivo');
                return false;
            }
        }
        
        // Si llegamos aqu√≠, el formulario es v√°lido
        console.log('‚úÖ Formulario v√°lido, procediendo con el env√≠o...');
        
        // Marcar como enviando DESPU√âS de que inicie el env√≠o
        setTimeout(() => {
            form.dataset.enviando = 'true';
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
                submitBtn.classList.add('btn-warning');
                submitBtn.classList.remove('btn-primary');
            }
        }, 100);
        
        // Timeout de seguridad
        setTimeout(() => {
            console.log('‚ö†Ô∏è Timeout de seguridad: liberando formulario');
            liberarFormulario();
        }, 30000);
        
        // Permitir que el formulario se env√≠e normalmente
        console.log('üöÄ Permitiendo env√≠o del formulario...');
        return true;
    });
    
    // Al cargar la p√°gina, verificar si hay mensajes de Django y liberar formulario
    setTimeout(() => {
        const mensajes = document.querySelectorAll('.alert, .messages div, .message');
        if (mensajes.length > 0) {
            console.log('Mensajes encontrados, liberando formulario');
            liberarFormulario();
        }
    }, 100);
    
    // Liberar formulario despu√©s de cualquier navegaci√≥n exitosa
    if (window.performance) {
        const navEntries = performance.getEntriesByType('navigation');
        if (navEntries.length > 0) {
            const navEntry = navEntries[0];
            // Si la p√°gina se recarg√≥ por una redirecci√≥n del servidor
            if (navEntry.type === 'reload' || navEntry.type === 'navigate') {
                liberarFormulario();
            }
        }
    }
    
    // Liberar formulario si hay un error de servidor o navegaci√≥n
    window.addEventListener('beforeunload', function() {
        liberarFormulario();
    });
    
    // Liberar formulario cuando la p√°gina se carga completamente (en caso de redirecci√≥n)
    window.addEventListener('load', function() {
        liberarFormulario();
    });

}); // Fin del DOMContentLoaded

// Funci√≥n para liberar el formulario despu√©s del env√≠o
function liberarFormulario() {
    console.log('Liberando formulario...');
    
    const form = document.querySelector('form');
    if (!form) return;
    
    // Cancelar timeout si existe
    if (form.dataset.timeoutId) {
        clearTimeout(parseInt(form.dataset.timeoutId));
        delete form.dataset.timeoutId;
    }
    
    // Liberar marca de enviando
    form.dataset.enviando = 'false';
    
    // Restaurar bot√≥n
    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.style.pointerEvents = '';
        submitBtn.innerHTML = 'Realizar Pago';
        submitBtn.classList.remove('btn-warning');
        submitBtn.classList.add('btn-primary');
    }
    
    // Restaurar formulario
    form.style.pointerEvents = '';
    
    console.log('Formulario liberado correctamente');
}

// Funci√≥n para mostrar errores
function mostrarError(mensaje) {
    // Liberar el formulario antes de mostrar el error
    liberarFormulario();
    
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            title: 'Campos obligatorios',
            text: mensaje,
            icon: 'warning',
            background: '#343a40',
            color: '#ffffff'
        });
    } else {
        alert(mensaje);
    }
}
</script>
{% endblock %}
