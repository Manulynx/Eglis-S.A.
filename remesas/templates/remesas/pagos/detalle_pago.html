{% extends 'eglisapp/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-md-4 mt-4">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
            <!-- Header -->
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
                <div class="mb-3 mb-md-0">
                    <h2 class="text-white mb-2">
                        <i class="fas fa-credit-card mr-2"></i>
                        <span class="d-none d-sm-inline">{{ title }}</span>
                        <span class="d-sm-none">Detalle Pago</span>
                    </h2>
                    <!-- Estado del Pago -->
                    <div class="mb-2">
                        {% if pago.estado == 'confirmado' %}
                            <span class="badge badge-success badge-lg">
                                <i class="fas fa-check-circle mr-1"></i>CONFIRMADO
                            </span>
                        {% elif pago.estado == 'pendiente' %}
                            <span class="badge badge-warning badge-lg">
                                <i class="fas fa-clock mr-1"></i>PENDIENTE
                            </span>
                        {% elif pago.estado == 'cancelado' %}
                            <span class="badge badge-danger badge-lg">
                                <i class="fas fa-times-circle mr-1"></i>CANCELADO
                            </span>
                        {% else %}
                            <span class="badge badge-secondary badge-lg">
                                <i class="fas fa-question-circle mr-1"></i>{{ pago.estado|upper }}
                            </span>
                        {% endif %}
                    </div>
                </div>
                <div class="d-flex flex-wrap gap-2 justify-content-end">
                    {% if user_tipo == 'admin' %}
                        <!-- Botones para Administradores -->
                        {% if pago.estado == 'pendiente' %}
                            <a href="{% url 'remesas:editar_pago' pago.id %}" class="btn btn-warning btn-sm">
                                <i class="fas fa-edit mr-1"></i>Editar
                            </a>
                            <button type="button" class="btn btn-success btn-sm btn-confirmar-pago"
                                    data-pago-id="{{ pago.id }}" data-pago-destinatario="{{ pago.destinatario }}">
                                <i class="fas fa-check mr-1"></i>Confirmar
                            </button>
                            <button type="button" class="btn btn-danger btn-sm btn-cancelar-pago"
                                    data-pago-id="{{ pago.id }}" data-pago-destinatario="{{ pago.destinatario }}">
                                <i class="fas fa-times mr-1"></i>Cancelar
                            </button>
                        {% elif pago.estado == 'confirmado' %}
                            <button type="button" class="btn btn-danger btn-sm btn-eliminar-pago"
                                    data-pago-id="{{ pago.id }}" data-pago-destinatario="{{ pago.destinatario }}">
                                <i class="fas fa-trash mr-1"></i>Eliminar
                            </button>
                        {% endif %}
                    {% elif user_tipo == 'contable' %}
                        <!-- Botones para Contables (sin eliminar) -->
                        {% if pago.estado == 'pendiente' %}
                            <a href="{% url 'remesas:editar_pago' pago.id %}" class="btn btn-warning btn-sm">
                                <i class="fas fa-edit mr-1"></i>Editar
                            </a>
                            <button type="button" class="btn btn-success btn-sm btn-confirmar-pago"
                                    data-pago-id="{{ pago.id }}" data-pago-destinatario="{{ pago.destinatario }}">
                                <i class="fas fa-check mr-1"></i>Confirmar
                            </button>
                            <button type="button" class="btn btn-danger btn-sm btn-cancelar-pago"
                                    data-pago-id="{{ pago.id }}" data-pago-destinatario="{{ pago.destinatario }}">
                                <i class="fas fa-times mr-1"></i>Cancelar
                            </button>
                        {% endif %}
                    {% else %}
                        <!-- Botones para Gestores (solo editar) -->
                        {% if pago.estado == 'pendiente' %}
                            <a href="{% url 'remesas:editar_pago' pago.id %}" class="btn btn-warning btn-sm">
                                <i class="fas fa-edit mr-1"></i>Editar
                            </a>
                        {% endif %}
                    {% endif %}
                    
                    <!-- Botón Volver (siempre visible) -->
                    <a href="{% url 'remesas:registro_transacciones' %}" class="btn btn-secondary btn-sm">
                        <i class="fas fa-arrow-left mr-1"></i>
                        <span class="d-none d-sm-inline">Volver</span>
                        <span class="d-sm-none">Volver</span>
                    </a>
                </div>
            </div>

            <!-- Card principal -->
            <div class="card bg-dark border-secondary">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center">
                        <h5 class="mb-2 mb-sm-0">
                            <i class="fas fa-info-circle mr-2"></i>
                            <span class="d-none d-md-inline">Información del Pago</span>
                            <span class="d-md-none">Info del Pago</span>
                        </h5>
                        <span class="badge badge-light badge-lg">{{ pago.pago_id|default:"Sin ID" }}</span>
                    </div>
                </div>
                <div class="card-body p-2 p-md-3">
                    <div class="row">
                        <!-- Información principal -->
                        <div class="col-12 col-lg-6 mb-4 mb-lg-0">
                            <h6 class="text-white border-bottom border-secondary pb-2 mb-3">
                                <i class="fas fa-file-alt mr-1"></i>
                                Datos del Pago
                            </h6>
                            
                            <div class="mb-3">
                                <label class="text-muted small">Tipo de Pago:</label>
                                <div>
                                    <span class="badge badge-{% if pago.tipo_pago == 'transferencia' %}info{% else %}warning{% endif %} badge-lg">
                                        <i class="fas fa-{% if pago.tipo_pago == 'transferencia' %}exchange-alt{% else %}money-bill-wave{% endif %} mr-1"></i>
                                        {{ pago.get_tipo_pago_display }}
                                    </span>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="text-muted small">Cantidad:</label>
                                <div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center">
                                    <span class="h4 text-success mb-1 mb-sm-0">
                                        <i class="fas fa-dollar-sign"></i>{{ pago.cantidad|floatformat:2 }}
                                    </span>
                                    {% if pago.tipo_moneda %}
                                        <span class="badge badge-secondary ml-sm-2">{{ pago.tipo_moneda.codigo }}</span>
                                    {% endif %}
                                </div>
                            </div>

                            {% if pago.tipo_moneda %}
                            <div class="mb-3">
                                <label class="text-muted small">Moneda:</label>
                                <div class="text-white">
                                    <strong>{{ pago.tipo_moneda.nombre }}</strong>
                                    <small class="text-muted d-block d-sm-inline">({{ pago.tipo_moneda.codigo }})</small>
                                </div>
                            </div>
                            {% endif %}

                            <div class="mb-3">
                                <label class="text-muted small">Fecha de Creación:</label>
                                <div class="text-white">
                                    <i class="fas fa-calendar mr-1"></i>
                                    <span class="d-block d-sm-inline">{{ pago.fecha_creacion|date:"d/m/Y" }}</span>
                                    <small class="text-muted d-block d-sm-inline ml-sm-2">{{ pago.fecha_creacion|date:"H:i" }}</small>
                                </div>
                            </div>
                        </div>

                        <!-- Información del destinatario -->
                        <div class="col-12 col-lg-6">
                            <h6 class="text-white border-bottom border-secondary pb-2 mb-3">
                                <i class="fas fa-user mr-1"></i>
                                Datos del Destinatario
                            </h6>
                            
                            <div class="mb-3">
                                <label class="text-muted small">Nombre Completo:</label>
                                <div class="text-white">
                                    <strong class="word-break">{{ pago.destinatario }}</strong>
                                </div>
                            </div>

                            {% if pago.carnet_identidad %}
                            <div class="mb-3">
                                <label class="text-muted small">Documento de Identidad:</label>
                                <div class="text-white">
                                    <i class="fas fa-id-card mr-1"></i>
                                    <span class="word-break">{{ pago.carnet_identidad }}</span>
                                </div>
                            </div>
                            {% endif %}

                            {% if pago.telefono %}
                            <div class="mb-3">
                                <label class="text-muted small">Teléfono:</label>
                                <div class="text-white">
                                    <i class="fas fa-phone mr-1"></i>
                                    <a href="tel:{{ pago.telefono }}" class="text-white text-decoration-none">
                                        {{ pago.telefono }}
                                    </a>
                                </div>
                            </div>
                            {% endif %}

                            {% if pago.direccion %}
                            <div class="mb-3">
                                <label class="text-muted small">Dirección:</label>
                                <div class="text-white">
                                    <i class="fas fa-map-marker-alt mr-1"></i>
                                    <span class="word-break">{{ pago.direccion }}</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Observaciones -->
                    {% if pago.observaciones %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <h6 class="text-white border-bottom border-secondary pb-2 mb-3">
                                <i class="fas fa-sticky-note mr-1"></i>
                                Observaciones
                            </h6>
                            <div class="alert alert-info bg-dark border-info text-white">
                                <i class="fas fa-info-circle mr-2"></i>
                                <div class="word-break">{{ pago.observaciones|linebreaks }}</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Comprobante de Pago -->
                    {% if pago.comprobante_pago %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <h6 class="text-white border-bottom border-secondary pb-2 mb-3">
                                <i class="fas fa-receipt mr-1"></i>
                                Comprobante de Pago
                            </h6>
                            <div class="text-center">
                                <div class="mb-3 comprobante-container">
                                    <img src="{{ pago.comprobante_pago.url }}" 
                                         alt="Comprobante de pago" 
                                         class="img-fluid rounded border border-secondary comprobante-img"
                                         onclick="mostrarComprobanteCompleto('{{ pago.comprobante_pago.url }}')">
                                </div>
                                <div class="d-flex flex-column flex-sm-row justify-content-center">
                                    <a href="{{ pago.comprobante_pago.url }}" 
                                       target="_blank" 
                                       class="btn btn-outline-light btn-sm mb-2 mb-sm-0 mr-sm-2">
                                        <i class="fas fa-eye mr-1"></i>
                                        <span class="d-none d-sm-inline">Ver en nueva pestaña</span>
                                        <span class="d-sm-none">Ver</span>
                                    </a>
                                    <a href="{{ pago.comprobante_pago.url }}" 
                                       download 
                                       class="btn btn-outline-success btn-sm">
                                        <i class="fas fa-download mr-1"></i>
                                        Descargar
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Acciones 
            <div class="card bg-dark border-secondary mt-3">
                <div class="card-body p-2 p-md-3">
                    <h6 class="text-white mb-3">
                        <i class="fas fa-cogs mr-1"></i>
                        Acciones Disponibles
                    </h6>
                    <div class="d-flex flex-column flex-sm-row justify-content-center">
                        <a href="{% url 'remesas:editar_pago' pago.id %}" class="btn btn-warning mb-2 mb-sm-0 mr-sm-2">
                            <i class="fas fa-edit mr-1"></i>
                            <span class="d-none d-md-inline">Editar Pago</span>
                            <span class="d-md-none">Editar</span>
                        </a>
                        <button type="button" 
                                class="btn btn-danger mb-2 mb-sm-0 mr-sm-2 btn-eliminar-pago"
                                data-pago-id="{{ pago.id }}"
                                data-pago-destinatario="{{ pago.destinatario }}">
                            <i class="fas fa-trash mr-1"></i>
                            <span class="d-none d-md-inline">Eliminar Pago</span>
                            <span class="d-md-none">Eliminar</span>
                        </button>
                        <a href="{% url 'remesas:registro_transacciones' %}" class="btn btn-secondary">
                            <i class="fas fa-list mr-1"></i>
                            <span class="d-none d-md-inline">Ver Todos los Pagos</span>
                            <span class="d-md-none">Ver Lista</span>
                        </a>
                    </div>
                </div>
            </div>-->

            <!-- Información adicional - Resumen 
            <div class="card bg-dark border-secondary mt-3">
                <div class="card-body p-2 p-md-3">
                    <h6 class="text-white mb-3">
                        <i class="fas fa-info-circle mr-1"></i>
                        Resumen:
                    </h6>
                    <div class="row text-center">
                        <div class="col-12 col-sm-4 mb-3 mb-sm-0">
                            <div class="text-muted small">ID del Pago</div>
                            <div class="h5 text-primary">#{{ pago.id }}</div>
                        </div>
                        <div class="col-12 col-sm-4 mb-3 mb-sm-0">
                            <div class="text-muted small">Monto Total</div>
                            <div class="h5 text-success">
                                ${{ pago.cantidad|floatformat:2 }}
                                {% if pago.tipo_moneda %}{{ pago.tipo_moneda.codigo }}{% endif %}
                            </div>
                        </div>
                        <div class="col-12 col-sm-4">
                            <div class="text-muted small">Método</div>
                            <div class="h5 text-info">{{ pago.get_tipo_pago_display }}</div>
                        </div>
                    </div>
                </div>
            </div> -->
        </div>
    </div>
</div>

<style>
/* Estilos responsivos para el detalle del pago */
/* Prevenir scroll horizontal en móviles */
html, body {
    overflow-x: hidden;
}

.container-fluid {
    max-width: 100%;
    overflow-x: hidden;
}

/* Estilo para los botones en línea */
.d-flex.flex-wrap.gap-2 {
    gap: 0.5rem !important;
    flex-direction: row !important;
    flex-wrap: wrap !important;
    align-items: center !important;
    justify-content: flex-end !important;
}

.d-flex.flex-wrap.gap-2 .btn {
    white-space: nowrap;
    min-width: auto;
    margin-bottom: 0 !important;
    width: auto !important;
}

/* Alineación específica para desktop */
@media (min-width: 768px) {
    .d-flex.flex-wrap.gap-2 {
        justify-content: flex-start !important;
    }
}

/* Estilos para el badge del estado */
.badge-lg {
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
    font-weight: 600;
    letter-spacing: 0.5px;
}

/* Estados específicos del pago */
.badge-success {
    background-color: #28a745 !important;
    color: white !important;
}

.badge-warning {
    background-color: #ffc107 !important;
    color: #212529 !important;
}

.badge-danger {
    background-color: #dc3545 !important;
    color: white !important;
}

.badge-secondary {
    background-color: #6c757d !important;
    color: white !important;
}

/* Ajustes específicos para móviles pequeños */
@media (max-width: 575.98px) {
    .container-fluid {
        padding-left: 8px !important;
        padding-right: 8px !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
    
    .card {
        margin-left: 0 !important;
        margin-right: 0 !important;
        border-radius: 8px;
    }
    
    .card-body {
        padding: 0.75rem !important;
    }
    
    .row {
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
    
    .col-12 {
        padding-left: 8px !important;
        padding-right: 8px !important;
    }
    
    /* Ajustes para el header */
    .d-flex.flex-column h2 {
        font-size: 1.4rem;
        margin-bottom: 1rem;
        word-break: break-word;
    }
    
    /* Botones más pequeños en móvil pero siempre en línea */
    .btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* Badge más pequeño en móvil */
    .badge-lg {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* Forzar botones en línea incluso en móvil - alineados a la derecha */
    .d-flex.flex-wrap.gap-2 {
        flex-direction: row !important;
        flex-wrap: wrap !important;
        gap: 0.25rem !important;
        justify-content: flex-end !important;
    }
    
    .d-flex.flex-wrap.gap-2 .btn {
        width: auto !important;
        margin-bottom: 0 !important;
        font-size: 0.7rem !important;
        padding: 0.2rem 0.4rem !important;
    }
    
    /* Tamaños de fuente más pequeños */
    .h4 {
        font-size: 1.2rem;
        word-break: break-word;
    }
    
    .h5 {
        font-size: 1.1rem;
        word-break: break-word;
    }
    
    .h6 {
        font-size: 1rem;
        word-break: break-word;
    }
    
    /* Contenedor de imagen más controlado */
    .comprobante-container {
        max-height: 250px;
        overflow: hidden;
        width: 100%;
    }
    
    .comprobante-img {
        max-height: 230px;
        width: 100%;
        object-fit: contain;
        cursor: pointer;
    }
    
    /* Prevenir desbordamiento de texto */
    .text-white, .text-muted, .small {
        word-wrap: break-word;
        word-break: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        max-width: 100%;
    }
    
    /* Espaciado más compacto */
    .mb-3 {
        margin-bottom: 1rem !important;
    }
    
    .mt-4 {
        margin-top: 1.5rem !important;
    }
    
    /* Card header responsive */
    .card-header {
        padding: 0.5rem !important;
    }
    
    .card-header .d-flex {
        flex-wrap: wrap;
    }
    
    .card-header h5 {
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }
}

/* Ajustes para móviles medianos */
@media (min-width: 576px) and (max-width: 767.98px) {
    .container-fluid {
        padding-left: 12px !important;
        padding-right: 12px !important;
    }
    
    .comprobante-container {
        max-height: 320px;
        overflow: hidden;
    }
    
    .comprobante-img {
        max-height: 300px;
        width: 100%;
        object-fit: contain;
        cursor: pointer;
    }
    
    /* Botones en línea para tablets */
    .d-flex.flex-wrap.gap-2 {
        flex-direction: row !important;
        flex-wrap: wrap !important;
        gap: 0.4rem !important;
    }
    
    .d-flex.flex-wrap.gap-2 .btn {
        width: auto !important;
        margin-bottom: 0 !important;
        font-size: 0.8rem !important;
    }
}

/* Ajustes para tablets y escritorio */
@media (min-width: 768px) {
    .comprobante-img {
        max-width: 100%;
        max-height: 400px;
        cursor: pointer;
    }
    
    /* Botones en línea para desktop */
    .d-flex.flex-wrap.gap-2 {
        flex-direction: row !important;
        flex-wrap: wrap !important;
        align-items: center !important;
        gap: 0.5rem !important;
    }
    
    .d-flex.flex-wrap.gap-2 .btn {
        width: auto !important;
        margin-bottom: 0 !important;
    }
}

/* Utilidades para prevenir desbordamiento */
.word-break {
    word-wrap: break-word !important;
    word-break: break-word !important;
    overflow-wrap: break-word !important;
    hyphens: auto;
    max-width: 100%;
}

/* Prevenir desbordamiento en alertas */
@media (max-width: 575.98px) {
    .alert {
        word-wrap: break-word;
        overflow-wrap: break-word;
        padding: 0.5rem;
    }
    
    .alert .word-break {
        white-space: pre-wrap;
    }
}

/* Ajustes para formularios pequeños */
@media (max-width: 575.98px) {
    .form-control {
        font-size: 16px; /* Prevenir zoom en iOS */
    }
}

/* Asegurar que ningún elemento cause scroll horizontal */
* {
    box-sizing: border-box;
}

@media (max-width: 575.98px) {
    * {
        max-width: 100%;
    }
    
    .container-fluid > .row > .col-12 {
        width: 100%;
        flex: 0 0 100%;
        max-width: 100%;
    }
}

/* Mejoras visuales para el header */
.d-flex.flex-column.flex-md-row > div:first-child {
    flex-grow: 1;
}

.d-flex.flex-wrap.gap-2 {
    flex-shrink: 0;
}
</style>

<!-- JavaScript -->
<script>
// Variable global para prevenir múltiples envíos
let isProcessing = false;

// Función para deshabilitar/habilitar todos los botones de acción
function toggleActionButtons(disabled) {
    const actionButtons = document.querySelectorAll('.btn-confirmar-pago, .btn-cancelar-pago, .btn-eliminar-pago');
    actionButtons.forEach(btn => {
        btn.disabled = disabled;
        if (disabled) {
            btn.classList.add('disabled');
            btn.style.pointerEvents = 'none';
        } else {
            btn.classList.remove('disabled');
            btn.style.pointerEvents = 'auto';
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Agregar event listeners a todos los botones de acción
    const btnEliminar = document.querySelector('.btn-eliminar-pago');
    const btnConfirmar = document.querySelector('.btn-confirmar-pago');
    const btnCancelar = document.querySelector('.btn-cancelar-pago');
    
    if (btnEliminar) {
        btnEliminar.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Verificar si ya está procesando
            if (isProcessing) {
                return;
            }
            
            const pagoId = this.getAttribute('data-pago-id');
            const destinatario = this.getAttribute('data-pago-destinatario');
            eliminarPago(pagoId, destinatario);
        });
    }
    
    if (btnConfirmar) {
        btnConfirmar.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Verificar si ya está procesando
            if (isProcessing) {
                return;
            }
            
            const pagoId = this.getAttribute('data-pago-id');
            const destinatario = this.getAttribute('data-pago-destinatario');
            confirmarPago(pagoId, destinatario);
        });
    }
    
    if (btnCancelar) {
        btnCancelar.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Verificar si ya está procesando
            if (isProcessing) {
                return;
            }
            
            const pagoId = this.getAttribute('data-pago-id');
            const destinatario = this.getAttribute('data-pago-destinatario');
            cancelarPago(pagoId, destinatario);
        });
    }
    
    // Protección adicional: deshabilitar botones si la página se está recargando
    window.addEventListener('beforeunload', function() {
        isProcessing = true;
        toggleActionButtons(true);
    });
});

function mostrarComprobanteCompleto(url) {
    Swal.fire({
        imageUrl: url,
        imageAlt: 'Comprobante de pago',
        showCloseButton: true,
        showConfirmButton: false,
        background: '#343a40',
        imageWidth: '90%',
        imageHeight: 'auto',
        customClass: {
            image: 'img-fluid'
        }
    });
}

function confirmarPago(pagoId, destinatario) {
    // Verificar si ya hay una petición en proceso
    if (isProcessing) {
        Swal.fire({
            title: 'Operación en Proceso',
            text: 'Ya hay una operación en curso. Por favor espere.',
            icon: 'warning',
            background: '#343a40',
            color: '#ffffff',
            confirmButtonColor: '#ffc107'
        });
        return;
    }
    
    Swal.fire({
        title: `¿Confirmar pago para ${destinatario}?`,
        text: "Esta acción deducirá el monto del balance del usuario y no se puede deshacer.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, confirmar',
        cancelButtonText: 'Cancelar',
        background: '#343a40',
        color: '#ffffff',
        allowOutsideClick: false
    }).then((result) => {
        if (result.isConfirmed) {
            // Marcar como procesando y deshabilitar botones
            isProcessing = true;
            toggleActionButtons(true);
            
            // Mostrar loading
            Swal.fire({
                title: 'Procesando...',
                text: 'Confirmando pago...',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                background: '#343a40',
                color: '#ffffff',
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            fetch(`/remesas/pagos/confirmar/${pagoId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                Swal.close();
                
                if (data.success) {
                    Swal.fire({
                        title: '¡Pago confirmado!',
                        text: 'El pago ha sido confirmado exitosamente.',
                        icon: 'success',
                        background: '#343a40',
                        color: '#ffffff',
                        allowOutsideClick: false
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    isProcessing = false;
                    toggleActionButtons(false);
                    
                    Swal.fire({
                        title: 'Error',
                        text: data.message || 'Ocurrió un error al confirmar el pago',
                        icon: 'error',
                        background: '#343a40',
                        color: '#ffffff'
                    });
                }
            })
            .catch(error => {
                Swal.close();
                isProcessing = false;
                toggleActionButtons(false);
                
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error de Conexión',
                    text: 'Ocurrió un error inesperado. Por favor, inténtelo de nuevo.',
                    icon: 'error',
                    background: '#343a40',
                    color: '#ffffff'
                });
            });
        }
    });
}

function cancelarPago(pagoId, destinatario) {
    // Verificar si ya hay una petición en proceso
    if (isProcessing) {
        Swal.fire({
            title: 'Operación en Proceso',
            text: 'Ya hay una operación en curso. Por favor espere.',
            icon: 'warning',
            background: '#343a40',
            color: '#ffffff',
            confirmButtonColor: '#ffc107'
        });
        return;
    }
    
    Swal.fire({
        title: `¿Cancelar pago para ${destinatario}?`,
        text: "Esta acción cancelará el pago y no se puede deshacer.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, cancelar',
        cancelButtonText: 'No, mantener',
        background: '#343a40',
        color: '#ffffff',
        allowOutsideClick: false
    }).then((result) => {
        if (result.isConfirmed) {
            // Marcar como procesando y deshabilitar botones
            isProcessing = true;
            toggleActionButtons(true);
            
            // Mostrar loading
            Swal.fire({
                title: 'Procesando...',
                text: 'Cancelando pago...',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                background: '#343a40',
                color: '#ffffff',
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            fetch(`/remesas/pagos/cancelar/${pagoId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                Swal.close();
                
                if (data.success) {
                    Swal.fire({
                        title: '¡Pago cancelado!',
                        text: 'El pago ha sido cancelado exitosamente.',
                        icon: 'success',
                        background: '#343a40',
                        color: '#ffffff',
                        allowOutsideClick: false
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    isProcessing = false;
                    toggleActionButtons(false);
                    
                    Swal.fire({
                        title: 'Error',
                        text: data.message || 'Ocurrió un error al cancelar el pago',
                        icon: 'error',
                        background: '#343a40',
                        color: '#ffffff'
                    });
                }
            })
            .catch(error => {
                Swal.close();
                isProcessing = false;
                toggleActionButtons(false);
                
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error de Conexión',
                    text: 'Ocurrió un error inesperado. Por favor, inténtelo de nuevo.',
                    icon: 'error',
                    background: '#343a40',
                    color: '#ffffff'
                });
            });
        }
    });
}

function eliminarPago(pagoId, destinatario) {
    // Verificar si ya hay una petición en proceso
    if (isProcessing) {
        Swal.fire({
            title: 'Operación en Proceso',
            text: 'Ya hay una operación en curso. Por favor espere.',
            icon: 'warning',
            background: '#343a40',
            color: '#ffffff',
            confirmButtonColor: '#ffc107'
        });
        return;
    }
    
    Swal.fire({
        title: '¿Estás seguro?',
        text: `Se eliminará el pago para "${destinatario}". Esta acción revertirá cualquier cambio en el balance.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar',
        background: '#343a40',
        color: '#ffffff',
        allowOutsideClick: false
    }).then((result) => {
        if (result.isConfirmed) {
            // Marcar como procesando y deshabilitar botones
            isProcessing = true;
            toggleActionButtons(true);
            
            // Mostrar loading
            Swal.fire({
                title: 'Procesando...',
                text: 'Eliminando pago...',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                background: '#343a40',
                color: '#ffffff',
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            fetch(`{% url 'remesas:eliminar_pago' 0 %}`.replace('0', pagoId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                Swal.close();
                
                if (data.success) {
                    Swal.fire({
                        title: '¡Eliminado!',
                        text: data.message,
                        icon: 'success',
                        background: '#343a40',
                        color: '#ffffff',
                        allowOutsideClick: false
                    }).then(() => {
                        window.location.href = '{% url "remesas:registro_transacciones" %}';
                    });
                } else {
                    isProcessing = false;
                    toggleActionButtons(false);
                    
                    Swal.fire({
                        title: 'Error',
                        text: data.message || 'Ocurrió un error al eliminar el pago',
                        icon: 'error',
                        background: '#343a40',
                        color: '#ffffff'
                    });
                }
            })
            .catch(error => {
                Swal.close();
                isProcessing = false;
                toggleActionButtons(false);
                
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error de Conexión',
                    text: 'Ocurrió un error inesperado. Por favor, inténtelo de nuevo.',
                    icon: 'error',
                    background: '#343a40',
                    color: '#ffffff'
                });
            });
        }
    });
}
</script>
</script>
{% endblock %}
