{% extends 'eglisapp/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid px-2 px-md-4 mt-4">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
            <!-- Header -->
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
                <div class="mb-3 mb-md-0">
                    <h2 class="text-white mb-2">
                        <i class="fas fa-file-invoice mr-2"></i>
                        <span class="d-none d-sm-inline">{{ title }}</span>
                        <span class="d-sm-none">Detalle Remesa</span>
                    </h2>
                    <!-- Estado de la Remesa -->
                    <div class="mb-2">
                        {% if remesa.estado == 'completada' %}
                            <span class="badge badge-success badge-lg">
                                <i class="fas fa-check-circle mr-1"></i>COMPLETADA
                            </span>
                        {% elif remesa.estado == 'pendiente' %}
                            <span class="badge badge-warning badge-lg">
                                <i class="fas fa-clock mr-1"></i>PENDIENTE
                            </span>
                        {% elif remesa.estado == 'cancelada' %}
                            <span class="badge badge-danger badge-lg">
                                <i class="fas fa-times-circle mr-1"></i>CANCELADA
                            </span>
                            {% if remesa.cancelado_por_tiempo %}
                                <span class="badge badge-dark badge-lg ml-2">
                                    <i class="fas fa-hourglass-end mr-1"></i>POR TIEMPO
                                </span>
                            {% endif %}
                        {% elif remesa.estado == 'confirmada' %}
                            <span class="badge badge-info badge-lg">
                                <i class="fas fa-check mr-1"></i>CONFIRMADA
                            </span>
                        {% else %}
                            <span class="badge badge-secondary badge-lg">
                                <i class="fas fa-question-circle mr-1"></i>{{ remesa.estado|upper }}
                            </span>
                        {% endif %}
                    </div>
                </div>
                <div class="d-flex flex-wrap gap-2 justify-content-end">
                    {% if user_tipo == 'admin' %}
                        <!-- Botones para Administradores -->
                        {% if remesa.estado == 'pendiente' %}
                            <a href="{% url 'remesas:editar_remesa' remesa.id %}" class="btn btn-warning btn-sm">
                                <i class="fas fa-edit mr-1"></i>Editar
                            </a>
                            <button type="button" class="btn btn-success btn-sm btn-confirmar-remesa"
                                    data-remesa-id="{{ remesa.id }}" data-remesa-numero="{{ remesa.remesa_id }}">
                                <i class="fas fa-check mr-1"></i>Confirmar
                            </button>
                            <button type="button" class="btn btn-danger btn-sm btn-cancelar-remesa"
                                    data-remesa-id="{{ remesa.id }}" data-remesa-numero="{{ remesa.remesa_id }}">
                                <i class="fas fa-times mr-1"></i>Cancelar
                            </button>
                        {% elif remesa.estado == 'cancelada' and remesa.cancelado_por_tiempo %}
                            <button type="button" class="btn btn-info btn-sm btn-reactivar-remesa"
                                    data-remesa-id="{{ remesa.id }}" data-remesa-numero="{{ remesa.remesa_id }}">
                                <i class="fas fa-redo mr-1"></i>Reactivar
                            </button>
                        {% elif remesa.estado == 'completada' %}
                            <button type="button" class="btn btn-danger btn-sm btn-eliminar-remesa"
                                    data-remesa-id="{{ remesa.id }}" data-remesa-numero="{{ remesa.remesa_id }}">
                                <i class="fas fa-trash mr-1"></i>Eliminar
                            </button>
                        {% endif %}
                    {% elif user_tipo == 'contable' %}
                        <!-- Botones para Contables (sin eliminar) -->
                        {% if remesa.estado == 'pendiente' %}
                            <a href="{% url 'remesas:editar_remesa' remesa.id %}" class="btn btn-warning btn-sm">
                                <i class="fas fa-edit mr-1"></i>Editar
                            </a>
                            <button type="button" class="btn btn-success btn-sm btn-confirmar-remesa"
                                    data-remesa-id="{{ remesa.id }}" data-remesa-numero="{{ remesa.remesa_id }}">
                                <i class="fas fa-check mr-1"></i>Confirmar
                            </button>
                            <button type="button" class="btn btn-danger btn-sm btn-cancelar-remesa"
                                    data-remesa-id="{{ remesa.id }}" data-remesa-numero="{{ remesa.remesa_id }}">
                                <i class="fas fa-times mr-1"></i>Cancelar
                            </button>
                        {% elif remesa.estado == 'cancelada' and remesa.cancelado_por_tiempo %}
                            <button type="button" class="btn btn-info btn-sm btn-reactivar-remesa"
                                    data-remesa-id="{{ remesa.id }}" data-remesa-numero="{{ remesa.remesa_id }}">
                                <i class="fas fa-redo mr-1"></i>Reactivar
                            </button>
                        {% endif %}
                    {% else %}
                        <!-- Botones para Gestores (solo editar) -->
                        {% if remesa.estado == 'pendiente' %}
                            <a href="{% url 'remesas:editar_remesa' remesa.id %}" class="btn btn-warning btn-sm">
                                <i class="fas fa-edit mr-1"></i>Editar
                            </a>
                        {% endif %}
                    {% endif %}
                    
                    <!-- Botón Volver (siempre visible) -->
                    <a href="{% url 'remesas:registro_transacciones' %}" class="btn btn-secondary btn-sm">
                        <i class="fas fa-arrow-left mr-1"></i>
                        <span class="d-none d-sm-inline">Volver</span>
                        <span class="d-sm-none">Volver</span>
                    </a>
                </div>
            </div>

            <!-- Card principal -->
            <div class="card bg-dark border-secondary">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center">
                        <h5 class="mb-2 mb-sm-0">
                            <i class="fas fa-info-circle mr-2"></i>
                            <span class="d-none d-md-inline">Información de la Remesa</span>
                            <span class="d-md-none">Info de la Remesa</span>
                        </h5>
                        <span class="badge badge-light badge-lg">{{ remesa.remesa_id|default:"Sin ID" }}</span>
                    </div>
                </div>
                <div class="card-body p-2 p-md-3">
                    <div class="row">
                        <!-- Información principal -->
                        <div class="col-12 col-lg-6 mb-4 mb-lg-0">
                            <h6 class="text-white border-bottom border-secondary pb-2 mb-3">
                                <i class="fas fa-file-alt mr-1"></i>
                                Datos de la Remesa
                            </h6>
                            
                            <div class="mb-3">
                                <label class="text-muted small">Tipo de Pago:</label>
                                <div>
                                    <span class="badge badge-{% if remesa.tipo_pago == 'transferencia' %}info{% else %}warning{% endif %} badge-lg">
                                        <i class="fas fa-{% if remesa.tipo_pago == 'transferencia' %}exchange-alt{% else %}money-bill-wave{% endif %} mr-1"></i>
                                        {{ remesa.get_tipo_pago_display|default:remesa.tipo_pago }}
                                    </span>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="text-muted small">Importe:</label>
                                <div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center">
                                    <span class="h4 text-success mb-1 mb-sm-0">
                                        <i class="fas fa-dollar-sign"></i>{{ remesa.importe|floatformat:2 }}
                                    </span>
                                    {% if remesa.moneda %}
                                        <span class="badge badge-secondary ml-sm-2">{{ remesa.moneda.codigo }}</span>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="text-muted small">Equivalente USD (al crear):</label>
                                <div class="text-white">
                                    <i class="fas fa-usd-circle mr-1"></i>
                                    {% if remesa.monto_usd_historico != None %}
                                        <span class="text-success" style="font-weight: 600;">${{ remesa.monto_usd_historico|floatformat:2 }} USD</span>
                                    {% else %}
                                        <span class="text-muted">N/D</span>
                                    {% endif %}
                                </div>
                                {% if remesa.moneda %}
                                <small class="text-muted d-block">
                                    Tasa usada (1 USD =
                                    {% if remesa.valor_moneda_historico != None %}
                                        {{ remesa.valor_moneda_historico|floatformat:6 }}
                                    {% else %}
                                        N/D
                                    {% endif %}
                                    {{ remesa.moneda.codigo }})
                                </small>
                                {% endif %}
                            </div>

                            {% if remesa.moneda %}
                            <div class="mb-3">
                                <label class="text-muted small">Moneda:</label>
                                <div class="text-white">
                                    <strong>{{ remesa.moneda.nombre }}</strong>
                                    <small class="text-muted d-block d-sm-inline">({{ remesa.moneda.codigo }})</small>
                                </div>
                            </div>
                            {% endif %}

                            <div class="mb-3">
                                <label class="text-muted small">Fecha de Creación:</label>
                                <div class="text-white">
                                    <i class="fas fa-calendar mr-1"></i>
                                    <span class="d-block d-sm-inline">{{ remesa.fecha|date:"d/m/Y" }}</span>
                                    <small class="text-muted d-block d-sm-inline ml-sm-2">{{ remesa.fecha|date:"H:i" }}</small>
                                </div>
                            </div>
                        </div>

                        <!-- Información del receptor y gestor -->
                        <div class="col-12 col-lg-6">
                            <h6 class="text-white border-bottom border-secondary pb-2 mb-3">
                                <i class="fas fa-user mr-1"></i>
                                Datos del Receptor
                            </h6>
                            
                            <div class="mb-3">
                                <label class="text-muted small">Receptor:</label>
                                <div class="text-white">
                                    <strong class="word-break">{{ remesa.receptor_nombre }}</strong>
                                </div>
                            </div>

                            {% if remesa.gestor %}
                            <div class="mb-3">
                                <label class="text-muted small">Gestor Asignado:</label>
                                <div class="text-white">
                                    <i class="fas fa-user-tie mr-1"></i>
                                    <span class="word-break">{{ remesa.gestor.get_full_name|default:remesa.gestor.username }}</span>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="text-muted small">Teléfono del Gestor:</label>
                                <div class="text-white">
                                    <i class="fas fa-phone mr-1"></i>
                                    {% if remesa.gestor.perfil.telefono %}
                                        <a href="tel:{{ remesa.gestor.perfil.telefono }}" class="text-success word-break">
                                            {{ remesa.gestor.perfil.telefono }}
                                        </a>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}

                            {% if remesa.observaciones %}
                            <div class="mb-3">
                                <label class="text-muted small">Observaciones:</label>
                                <div class="text-white">
                                    <i class="fas fa-sticky-note mr-1"></i>
                                    <span class="word-break">{{ remesa.observaciones }}</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Comprobante de Remesa -->
                    {% if remesa.comprobante %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <h6 class="text-white border-bottom border-secondary pb-2 mb-3">
                                <i class="fas fa-receipt mr-1"></i>
                                Comprobante de Remesa
                            </h6>
                            <div class="text-center">
                                <div class="mb-3 comprobante-container">
                                    <img src="{{ remesa.comprobante.url }}" 
                                         alt="Comprobante de remesa" 
                                         class="img-fluid rounded border border-secondary comprobante-img"
                                         onclick="mostrarComprobanteCompleto('{{ remesa.comprobante.url }}')">
                                </div>
                                <div class="d-flex flex-column flex-sm-row justify-content-center">
                                    <a href="{{ remesa.comprobante.url }}" 
                                       target="_blank" 
                                       class="btn btn-outline-light btn-sm mb-2 mb-sm-0 mr-sm-2">
                                        <i class="fas fa-eye mr-1"></i>
                                        <span class="d-none d-sm-inline">Ver en nueva pestaña</span>
                                        <span class="d-sm-none">Ver</span>
                                    </a>
                                    <a href="{{ remesa.comprobante.url }}" 
                                       download 
                                       class="btn btn-outline-success btn-sm">
                                        <i class="fas fa-download mr-1"></i>
                                        Descargar
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>



            <!-- Pagos Enlazados a la Remesa -->
            <div class="card bg-dark border-secondary mt-3" id="pagos">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-money-bill-wave mr-1"></i>
                        Pagos Enlazados a esta Remesa
                    </h6>
                    {% if remesa.estado == 'pendiente' or user_tipo == 'admin' or user_tipo == 'contable' %}
                    <button type="button" class="btn btn-sm btn-light" id="btnMostrarFormularioPago">
                        <i class="fas fa-plus mr-1"></i>
                        Agregar Pago
                    </button>
                    {% endif %}
                </div>
                <div class="card-body p-2 p-md-3">
                    <!-- Formulario para crear pago (inicialmente oculto) -->
                    <div id="formularioPagoRemesa" style="display: none;" class="mb-4">
                        <div class="card bg-secondary">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 text-white">Nuevo Pago para Remesa {{ remesa.remesa_id }}</h6>
                                <button type="button" class="btn btn-sm btn-danger" id="btnCerrarFormularioPago">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <form id="formPagoRemesa" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <div class="row">
                                        <!-- Tipo de Pago -->
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form_pago_remesa.tipo_pago.id_for_label }}" class="form-label text-white">
                                                {{ form_pago_remesa.tipo_pago.label }}
                                                <span class="text-danger">*</span>
                                            </label>
                                            {{ form_pago_remesa.tipo_pago }}
                                            <div class="invalid-feedback"></div>
                                        </div>
                                        
                                        <!-- Moneda -->
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form_pago_remesa.tipo_moneda.id_for_label }}" class="form-label text-white">
                                                {{ form_pago_remesa.tipo_moneda.label }}
                                                <span class="text-danger">*</span>
                                            </label>
                                            {{ form_pago_remesa.tipo_moneda }}
                                            <div class="invalid-feedback"></div>
                                        </div>
                                        
                                        <!-- Cantidad -->
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form_pago_remesa.cantidad.id_for_label }}" class="form-label text-white">
                                                {{ form_pago_remesa.cantidad.label }}
                                                <span class="text-danger">*</span>
                                            </label>
                                            {{ form_pago_remesa.cantidad }}
                                            <div class="invalid-feedback"></div>
                                        </div>
                                        
                                        <!-- Destinatario -->
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form_pago_remesa.destinatario.id_for_label }}" class="form-label text-white">
                                                {{ form_pago_remesa.destinatario.label }}
                                                <span class="text-danger">*</span>
                                            </label>
                                            {{ form_pago_remesa.destinatario }}
                                            <div class="invalid-feedback"></div>
                                        </div>
                                        
                                        <!-- Teléfono -->
                                        <div class="col-md-6 mb-3" id="div_telefono">
                                            <label for="{{ form_pago_remesa.telefono.id_for_label }}" class="form-label text-white">
                                                {{ form_pago_remesa.telefono.label }}
                                                <span class="text-danger" id="telefono_required" style="display: none;">*</span>
                                            </label>
                                            {{ form_pago_remesa.telefono }}
                                            <div class="invalid-feedback"></div>
                                        </div>
                                        
                                        <!-- Dirección -->
                                        <div class="col-md-6 mb-3" id="div_direccion">
                                            <label for="{{ form_pago_remesa.direccion.id_for_label }}" class="form-label text-white">
                                                {{ form_pago_remesa.direccion.label }}
                                                <span class="text-danger" id="direccion_required" style="display: none;">*</span>
                                            </label>
                                            {{ form_pago_remesa.direccion }}
                                            <div class="invalid-feedback"></div>
                                        </div>
                                        
                                        <!-- Cédula/Documento -->
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form_pago_remesa.carnet_identidad.id_for_label }}" class="form-label text-white">
                                                {{ form_pago_remesa.carnet_identidad.label }}
                                            </label>
                                            {{ form_pago_remesa.carnet_identidad }}
                                            <div class="invalid-feedback"></div>
                                        </div>
                                        
                                        <!-- Número de Tarjeta -->
                                        <div class="col-md-6 mb-3" id="div_tarjeta" style="display: none;">
                                            <label for="{{ form_pago_remesa.tarjeta.id_for_label }}" class="form-label text-white">
                                                {{ form_pago_remesa.tarjeta.label }}
                                                <span class="text-danger">*</span>
                                            </label>
                                            {{ form_pago_remesa.tarjeta }}
                                            <div class="invalid-feedback"></div>
                                        </div>
                                        
                                        <!-- Comprobante -->
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form_pago_remesa.comprobante_pago.id_for_label }}" class="form-label text-white">
                                                {{ form_pago_remesa.comprobante_pago.label }}
                                            </label>
                                            {{ form_pago_remesa.comprobante_pago }}
                                            <div class="invalid-feedback"></div>
                                        </div>
                                        
                                        <!-- Observaciones -->
                                        <div class="col-12 mb-3">
                                            <label for="{{ form_pago_remesa.observaciones.id_for_label }}" class="form-label text-white">
                                                {{ form_pago_remesa.observaciones.label }}
                                            </label>
                                            {{ form_pago_remesa.observaciones }}
                                            <div class="invalid-feedback"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex justify-content-end gap-2">
                                        <button type="button" class="btn btn-secondary" id="btnCancelarPago">
                                            <i class="fas fa-times mr-1"></i>Cancelar
                                        </button>
                                        <button type="submit" class="btn btn-success" id="btnGuardarPago">
                                            <i class="fas fa-save mr-1"></i>Guardar Pago
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de pagos enlazados -->
                    <div id="listaPagosEnlazados">
                        {% if pagos_enlazados %}
                        <!-- Vista Desktop -->
                        <div class="d-none d-lg-block">
                            {% for pago in pagos_enlazados %}
                            <div class="card bg-secondary border-secondary mb-3" id="pago-{{ pago.id }}">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="badge badge-primary mr-2">{{ pago.pago_id }}</span>
                                        <span class="badge badge-{% if pago.tipo_pago == 'transferencia' %}info{% else %}warning{% endif %}">
                                            {{ pago.get_tipo_pago_display }}
                                        </span>
                                        <span class="badge badge-{% if pago.estado == 'confirmado' %}success{% elif pago.estado == 'pendiente' %}warning{% else %}danger{% endif %}">
                                            {{ pago.get_estado_display }}
                                        </span>
                                        {% if pago.estado == 'cancelado' and pago.cancelado_por_tiempo %}
                                            <span class="badge badge-dark ml-2">
                                                <i class="fas fa-hourglass-end mr-1"></i>POR TIEMPO
                                            </span>
                                        {% endif %}
                                    </div>
                                    <div>
                                        {% if pago.estado == 'pendiente' %}
                                            {% if user_tipo == 'admin' or user_tipo == 'contable' or remesa.gestor == request.user %}
                                            <a href="{% url 'remesas:editar_pago_remesa' pago.id %}" 
                                               class="btn btn-sm btn-warning mr-1"
                                               title="Editar pago">
                                                <i class="fas fa-edit mr-1"></i>Editar
                                            </a>
                                            {% endif %}
                                            {% if remesa.estado == 'completada' %}
                                                {% if user_tipo == 'admin' or user_tipo == 'contable' %}
                                                <button type="button" class="btn btn-sm btn-success btn-confirmar-pago-remesa"
                                                        data-pago-id="{{ pago.id }}"
                                                        data-pago-numero="{{ pago.pago_id }}"
                                                        title="Confirmar pago">
                                                    <i class="fas fa-check mr-1"></i>Confirmar
                                                </button>
                                                <button type="button" class="btn btn-sm btn-danger btn-cancelar-pago-remesa"
                                                        data-pago-id="{{ pago.id }}"
                                                        data-pago-numero="{{ pago.pago_id }}"
                                                        title="Cancelar pago">
                                                    <i class="fas fa-times mr-1"></i>Cancelar
                                                </button>
                                                {% endif %}
                                            {% else %}
                                                {% if user_tipo == 'admin' or user_tipo == 'contable' or remesa.gestor == request.user %}
                                                <button type="button" class="btn btn-sm btn-outline-danger btn-eliminar-pago-remesa" 
                                                        data-pago-id="{{ pago.id }}" 
                                                        data-pago-numero="{{ pago.pago_id }}"
                                                        title="Eliminar pago">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                {% endif %}
                                            {% endif %}
                                        {% endif %}
                                        {% if pago.estado == 'cancelado' and pago.cancelado_por_tiempo %}
                                            {% if user_tipo == 'admin' or user_tipo == 'contable' %}
                                            <button type="button" class="btn btn-sm btn-info btn-reactivar-pago-remesa"
                                                    data-pago-id="{{ pago.id }}"
                                                    data-pago-numero="{{ pago.pago_id }}"
                                                    title="Reactivar pago (crea uno nuevo)">
                                                <i class="fas fa-redo mr-1"></i>Reactivar
                                            </button>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="text-muted small">Destinatario:</label>
                                                <div class="text-white"><strong>{{ pago.destinatario }}</strong></div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="text-muted small">Cantidad:</label>
                                                <div>
                                                    <span class="h5 text-success">{{ pago.cantidad|floatformat:2 }}</span>
                                                    {% if pago.tipo_moneda %}
                                                    <span class="badge badge-secondary ml-2">{{ pago.tipo_moneda.codigo }}</span>
                                                    {% endif %}
                                                </div>
                                                {% if pago.monto_usd_historico %}
                                                <small class="text-muted">Equiv. USD: ${{ pago.monto_usd_historico|floatformat:2 }}</small>
                                                {% endif %}
                                                {% if pago.tipo_moneda %}
                                                    {% if pago.valor_moneda_historico != None %}
                                                    <small class="text-muted d-block">Tasa usada: 1 USD = {{ pago.valor_moneda_historico|floatformat:6 }} {{ pago.tipo_moneda.codigo }}</small>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                            {% if pago.telefono %}
                                            <div class="mb-3">
                                                <label class="text-muted small">Teléfono:</label>
                                                <div class="text-white">
                                                    <i class="fas fa-phone mr-1"></i>
                                                    <a href="tel:{{ pago.telefono }}" class="text-info">{{ pago.telefono }}</a>
                                                </div>
                                            </div>
                                            {% endif %}
                                            {% if pago.carnet_identidad %}
                                            <div class="mb-3">
                                                <label class="text-muted small">CI/Documento:</label>
                                                <div class="text-white">{{ pago.carnet_identidad }}</div>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-6">
                                            {% if pago.tarjeta %}
                                            <div class="mb-3">
                                                <label class="text-muted small">Número de Tarjeta:</label>
                                                <div class="text-white">
                                                    <i class="fas fa-credit-card mr-1"></i>{{ pago.tarjeta }}
                                                </div>
                                            </div>
                                            {% endif %}
                                            {% if pago.direccion %}
                                            <div class="mb-3">
                                                <label class="text-muted small">Dirección:</label>
                                                <div class="text-white">{{ pago.direccion }}</div>
                                            </div>
                                            {% endif %}
                                            <div class="mb-3">
                                                <label class="text-muted small">Fecha de Creación:</label>
                                                <div class="text-white">
                                                    <i class="fas fa-calendar mr-1"></i>
                                                    {{ pago.fecha_creacion|date:"d/m/Y H:i" }}
                                                </div>
                                            </div>
                                            {% if pago.usuario %}
                                            <div class="mb-3">
                                                <label class="text-muted small">Creado por:</label>
                                                <div class="text-white">
                                                    <i class="fas fa-user mr-1"></i>
                                                    {{ pago.usuario.get_full_name|default:pago.usuario.username }}
                                                </div>
                                            </div>
                                            {% endif %}
                                            {% if pago.editado %}
                                            <div class="mb-3">
                                                <span class="badge badge-warning">
                                                    <i class="fas fa-edit mr-1"></i>Editado
                                                </span>
                                                {% if pago.fecha_edicion %}
                                                <small class="text-muted d-block">{{ pago.fecha_edicion|date:"d/m/Y H:i" }}</small>
                                                {% endif %}
                                                {% if pago.usuario_editor %}
                                                <small class="text-muted d-block">Por: {{ pago.usuario_editor.get_full_name|default:pago.usuario_editor.username }}</small>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if pago.observaciones %}
                                    <div class="row">
                                        <div class="col-12">
                                            <label class="text-muted small">Observaciones:</label>
                                            <div class="text-white">{{ pago.observaciones }}</div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if pago.comprobante_pago %}
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <label class="text-muted small">Comprobante:</label>
                                            <div class="text-center">
                                                <img src="{{ pago.comprobante_pago.url }}" 
                                                     alt="Comprobante" 
                                                     class="img-fluid rounded border border-secondary"
                                                     style="max-height: 200px; cursor: pointer;"
                                                     onclick="mostrarComprobanteCompleto('{{ pago.comprobante_pago.url }}')">
                                                <div class="mt-2">
                                                    <a href="{{ pago.comprobante_pago.url }}" target="_blank" class="btn btn-sm btn-outline-light">
                                                        <i class="fas fa-eye mr-1"></i>Ver
                                                    </a>
                                                    <a href="{{ pago.comprobante_pago.url }}" download class="btn btn-sm btn-outline-success">
                                                        <i class="fas fa-download mr-1"></i>Descargar
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Vista Mobile/Tablet -->
                        <div class="d-lg-none">
                            {% for pago in pagos_enlazados %}
                            <div class="card bg-secondary border-secondary mb-3" id="pago-{{ pago.id }}">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div style="flex: 1;">
                                            <div class="mb-2">
                                                <span class="badge badge-primary d-inline-block">{{ pago.pago_id }}</span>
                                            </div>
                                            <div>
                                                <span class="badge badge-{% if pago.tipo_pago == 'transferencia' %}info{% else %}warning{% endif %}">
                                                    <i class="fas fa-{% if pago.tipo_pago == 'transferencia' %}exchange-alt{% else %}money-bill-wave{% endif %}"></i>
                                                    {{ pago.get_tipo_pago_display }}
                                                </span>
                                                <span class="badge badge-{% if pago.estado == 'confirmado' %}success{% elif pago.estado == 'pendiente' %}warning{% else %}danger{% endif %}">
                                                    <i class="fas fa-{% if pago.estado == 'confirmado' %}check-circle{% elif pago.estado == 'pendiente' %}clock{% else %}times-circle{% endif %}"></i>
                                                    {{ pago.get_estado_display }}
                                                </span>
                                                {% if pago.estado == 'cancelado' and pago.cancelado_por_tiempo %}
                                                    <span class="badge badge-dark ml-2">
                                                        <i class="fas fa-hourglass-end"></i>
                                                        Por tiempo
                                                    </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="text-end" style="margin-left: 0.5rem;">
                                            <div class="h5 text-success mb-1" style="white-space: nowrap;">
                                                ${{ pago.cantidad|floatformat:2 }}
                                            </div>
                                            {% if pago.tipo_moneda %}
                                            <span class="badge badge-secondary" style="font-size: 0.7rem;">{{ pago.tipo_moneda.codigo }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Destinatario -->
                                    <div class="mb-2 pb-2 border-bottom border-secondary">
                                        <small class="text-muted small d-block mb-1">Destinatario:</small>
                                        <strong class="text-white d-block">{{ pago.destinatario }}</strong>
                                    </div>
                                    
                                    <!-- Información de contacto -->
                                    {% if pago.telefono or pago.carnet_identidad %}
                                    <div class="mb-2 pb-2 border-bottom border-secondary">
                                        {% if pago.telefono %}
                                        <div class="mb-1">
                                            <small class="text-muted small">Teléfono:</small>
                                            <a href="tel:{{ pago.telefono }}" class="text-info d-block">
                                                <i class="fas fa-phone"></i> {{ pago.telefono }}
                                            </a>
                                        </div>
                                        {% endif %}
                                        {% if pago.carnet_identidad %}
                                        <div class="mb-1">
                                            <small class="text-muted small">CI/Documento:</small>
                                            <span class="text-white d-block">{{ pago.carnet_identidad }}</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Dirección -->
                                    {% if pago.direccion %}
                                    <div class="mb-2 pb-2 border-bottom border-secondary">
                                        <small class="text-muted small d-block mb-1">Dirección:</small>
                                        <span class="text-white d-block" style="font-size: 0.85rem;">{{ pago.direccion }}</span>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Tarjeta (para transferencias) -->
                                    {% if pago.tarjeta %}
                                    <div class="mb-2 pb-2 border-bottom border-secondary">
                                        <small class="text-muted small d-block mb-1">Número de Tarjeta:</small>
                                        <span class="text-white d-block">
                                            <i class="fas fa-credit-card text-info"></i> {{ pago.tarjeta }}
                                        </span>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Equivalente USD -->
                                    {% if pago.monto_usd_historico %}
                                    <div class="mb-2 pb-2 border-bottom border-secondary">
                                        <small class="text-muted small d-block mb-1">Equivalente USD:</small>
                                        <span class="text-success d-block" style="font-weight: 600;">
                                            ${{ pago.monto_usd_historico|floatformat:2 }} USD
                                        </span>
                                    </div>
                                    {% endif %}

                                    <!-- Tasa usada -->
                                    {% if pago.tipo_moneda %}
                                        {% if pago.valor_moneda_historico != None %}
                                        <div class="mb-2 pb-2 border-bottom border-secondary">
                                            <small class="text-muted small d-block mb-1">Tasa usada (al crear):</small>
                                            <span class="text-white d-block" style="font-size: 0.85rem;">
                                                1 USD = {{ pago.valor_moneda_historico|floatformat:6 }} {{ pago.tipo_moneda.codigo }}
                                            </span>
                                        </div>
                                        {% endif %}
                                    {% endif %}
                                    
                                    <!-- Fecha y usuario -->
                                    <div class="mb-2 pb-2 border-bottom border-secondary">
                                        <div class="d-flex justify-content-between align-items-start flex-wrap">
                                            <div style="flex: 1; min-width: 0;">
                                                <small class="text-muted small d-block mb-1">Fecha:</small>
                                                <span class="text-white d-block" style="font-size: 0.8rem;">
                                                    <i class="fas fa-calendar"></i> {{ pago.fecha_creacion|date:"d/m/Y H:i" }}
                                                </span>
                                            </div>
                                            {% if pago.usuario %}
                                            <div style="margin-left: 0.5rem; flex: 1; min-width: 0;">
                                                <small class="text-muted small d-block mb-1">Creado por:</small>
                                                <span class="text-white d-block" style="font-size: 0.8rem;">
                                                    <i class="fas fa-user"></i> {{ pago.usuario.get_full_name|default:pago.usuario.username|truncatechars:20 }}
                                                </span>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Observaciones -->
                                    {% if pago.observaciones %}
                                    <div class="mb-2 pb-2 border-bottom border-secondary">
                                        <small class="text-muted small d-block mb-1">Observaciones:</small>
                                        <span class="text-white d-block" style="font-size: 0.85rem;">{{ pago.observaciones }}</span>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Editado -->
                                    {% if pago.editado %}
                                    <div class="mb-2 pb-2 border-bottom border-secondary">
                                        <span class="badge badge-warning d-inline-block mb-1">
                                            <i class="fas fa-edit"></i> Editado
                                        </span>
                                        {% if pago.fecha_edicion %}
                                        <small class="text-muted d-block" style="font-size: 0.7rem;">{{ pago.fecha_edicion|date:"d/m/Y H:i" }}</small>
                                        {% endif %}
                                        {% if pago.usuario_editor %}
                                        <small class="text-muted d-block" style="font-size: 0.7rem;">Por: {{ pago.usuario_editor.get_full_name|default:pago.usuario_editor.username }}</small>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Comprobante -->
                                    {% if pago.comprobante_pago %}
                                    <div class="mb-3 text-center">
                                        <small class="text-muted small d-block mb-2">Comprobante de Pago:</small>
                                        <img src="{{ pago.comprobante_pago.url }}" 
                                             alt="Comprobante" 
                                             class="img-fluid rounded border border-secondary"
                                             style="max-height: 150px; cursor: pointer;"
                                             onclick="mostrarComprobanteCompleto('{{ pago.comprobante_pago.url }}')">
                                        <div class="mt-2">
                                            <a href="{{ pago.comprobante_pago.url }}" target="_blank" class="btn btn-sm btn-outline-info">
                                                <i class="fas fa-eye"></i> Ver
                                            </a>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Botones de acción -->
                                    <div class="mt-3 pt-2 border-top border-secondary">
                                        <div class="d-flex gap-2 flex-wrap">
                                            {% if pago.estado == 'pendiente' %}
                                                {% if user_tipo == 'admin' or user_tipo == 'contable' or remesa.gestor == request.user %}
                                                <a href="{% url 'remesas:editar_pago_remesa' pago.id %}" 
                                                   class="btn btn-sm btn-warning flex-fill">
                                                    <i class="fas fa-edit"></i> Editar
                                                </a>
                                                {% endif %}
                                                {% if remesa.estado == 'completada' %}
                                                    {% if user_tipo == 'admin' or user_tipo == 'contable' %}
                                                    <button type="button" class="btn btn-sm btn-success flex-fill btn-confirmar-pago-remesa"
                                                            data-pago-id="{{ pago.id }}"
                                                            data-pago-numero="{{ pago.pago_id }}">
                                                        <i class="fas fa-check"></i> Confirmar
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-danger flex-fill btn-cancelar-pago-remesa"
                                                            data-pago-id="{{ pago.id }}"
                                                            data-pago-numero="{{ pago.pago_id }}">
                                                        <i class="fas fa-times"></i> Cancelar
                                                    </button>
                                                    {% endif %}
                                                {% else %}
                                                    {% if user_tipo == 'admin' or user_tipo == 'contable' or remesa.gestor == request.user %}
                                                    <button type="button" class="btn btn-sm btn-outline-danger flex-fill btn-eliminar-pago-remesa" 
                                                            data-pago-id="{{ pago.id }}" 
                                                            data-pago-numero="{{ pago.pago_id }}">
                                                        <i class="fas fa-trash"></i> Eliminar
                                                    </button>
                                                    {% endif %}
                                                {% endif %}
                                            {% endif %}
                                            {% if pago.estado == 'cancelado' and pago.cancelado_por_tiempo %}
                                                {% if user_tipo == 'admin' or user_tipo == 'contable' %}
                                                <button type="button" class="btn btn-sm btn-info flex-fill btn-reactivar-pago-remesa"
                                                        data-pago-id="{{ pago.id }}"
                                                        data-pago-numero="{{ pago.pago_id }}">
                                                    <i class="fas fa-redo"></i> Reactivar
                                                </button>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle mr-2"></i>
                            No hay pagos enlazados a esta remesa todavía.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Información adicional - Resumen 
            <div class="card bg-dark border-secondary mt-3">
                <div class="card-body p-2 p-md-3">
                    <h6 class="text-white mb-3">
                        <i class="fas fa-info-circle mr-1"></i>
                        Resumen:
                    </h6>
                    <div class="row text-center">
                        <div class="col-12 col-sm-4 mb-3 mb-sm-0">
                            <div class="text-muted small">ID de la Remesa</div>
                            <div class="h5 text-primary">#{{ remesa.remesa_id }}</div>
                        </div>
                        <div class="col-12 col-sm-4 mb-3 mb-sm-0">
                            <div class="text-muted small">Importe Total</div>
                            <div class="h5 text-success">
                                ${{ remesa.importe|floatformat:2 }}
                                {% if remesa.moneda %}{{ remesa.moneda.codigo }}{% endif %}
                            </div>
                        </div>
                        <div class="col-12 col-sm-4">
                            <div class="text-muted small">Método</div>
                            <div class="h5 text-info">{{ remesa.get_tipo_pago_display|default:remesa.tipo_pago }}</div>
                        </div>
                    </div>
                </div>
            </div>-->
        </div>
    </div>
</div>

<!-- Modal para ver comprobante en tamaño completo -->
<div class="modal fade" id="comprobanteModal" tabindex="-1" aria-labelledby="comprobanteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white" id="comprobanteModalLabel">Comprobante de Remesa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalComprobanteImage" src="" alt="Comprobante" class="img-fluid rounded">
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <a id="comprobanteDownloadLink" href="" download class="btn btn-primary">
                    <i class="fas fa-download mr-1"></i>Descargar
                </a>
            </div>
        </div>
    </div>
</div>

<style>
/* ========== ESTILOS GENERALES ========== */
.gap-2 {
    gap: 0.5rem !important;
}

.justify-content-end {
    justify-content: flex-end !important;
}

.badge-lg {
    font-size: 0.875rem;
    padding: 0.5rem 0.75rem;
    font-weight: 600;
}

.word-break {
    word-break: break-word;
    word-wrap: break-word;
}

.comprobante-container {
    max-width: 100%;
    overflow: hidden;
}

.comprobante-img {
    max-height: 300px;
    cursor: pointer;
    transition: transform 0.2s;
    border: 2px solid rgba(255, 255, 255, 0.1);
}

.comprobante-img:hover {
    transform: scale(1.02);
    border-color: rgba(255, 255, 255, 0.3);
}

/* ========== TARJETAS DE PAGOS ========== */
.card.bg-secondary {
    background: linear-gradient(145deg, #2d3238 0%, #1f2226 100%) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
}

.card.bg-secondary:hover {
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
    border-color: rgba(255, 255, 255, 0.2) !important;
}

.card.bg-secondary .card-header {
    background: linear-gradient(135deg, #3a4149 0%, #2d3238 100%);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 1rem;
}

.card.bg-secondary .card-body {
    padding: 1.25rem;
}

/* ========== BADGES MEJORADOS ========== */
.badge-primary {
    background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%) !important;
    color: #ffffff !important;
    font-weight: 600;
    padding: 0.5em 0.8em;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
}

.badge-info {
    background: linear-gradient(135deg, #0dcaf0 0%, #0aa2c0 100%) !important;
    color: #000000 !important;
    font-weight: 600;
    padding: 0.5em 0.8em;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(13, 202, 240, 0.3);
}

.badge-warning {
    background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%) !important;
    color: #000000 !important;
    font-weight: 600;
    padding: 0.5em 0.8em;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
}

.badge-success {
    background: linear-gradient(135deg, #198754 0%, #146c43 100%) !important;
    color: #ffffff !important;
    font-weight: 600;
    padding: 0.5em 0.8em;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(25, 135, 84, 0.3);
}

.badge-danger {
    background: linear-gradient(135deg, #dc3545 0%, #bb2d3b 100%) !important;
    color: #ffffff !important;
    font-weight: 600;
    padding: 0.5em 0.8em;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
}

.badge-secondary {
    background: linear-gradient(135deg, #6c757d 0%, #565e64 100%) !important;
    color: #ffffff !important;
    font-weight: 600;
    padding: 0.5em 0.8em;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
}

/* ========== TEXTOS Y LABELS ========== */
.text-muted.small {
    color: #adb5bd !important;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.75rem;
}

.text-white {
    color: #f8f9fa !important;
}

.text-success {
    color: #20c997 !important;
    font-weight: 600;
}

.text-info {
    color: #0dcaf0 !important;
}

.h5.text-success {
    color: #20c997 !important;
    text-shadow: 0 0 10px rgba(32, 201, 151, 0.3);
}

/* ========== BOTONES MEJORADOS ========== */
.btn-success {
    background: linear-gradient(135deg, #198754 0%, #146c43 100%);
    border: none;
    box-shadow: 0 2px 4px rgba(25, 135, 84, 0.3);
    transition: all 0.3s ease;
}

.btn-success:hover {
    background: linear-gradient(135deg, #157347 0%, #0f5132 100%);
    box-shadow: 0 4px 8px rgba(25, 135, 84, 0.4);
    transform: translateY(-1px);
}

.btn-danger {
    background: linear-gradient(135deg, #dc3545 0%, #bb2d3b 100%);
    border: none;
    box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    transition: all 0.3s ease;
}

.btn-danger:hover {
    background: linear-gradient(135deg, #bb2d3b 0%, #a02834 100%);
    box-shadow: 0 4px 8px rgba(220, 53, 69, 0.4);
    transform: translateY(-1px);
}

.btn-outline-danger {
    border-color: #dc3545;
    color: #dc3545;
    transition: all 0.3s ease;
}

.btn-outline-danger:hover {
    background-color: #dc3545;
    color: #ffffff;
    box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    transform: translateY(-1px);
}

.btn-outline-light {
    border-color: rgba(255, 255, 255, 0.3);
    color: #f8f9fa;
    transition: all 0.3s ease;
}

.btn-outline-light:hover {
    background-color: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.5);
    color: #ffffff;
}

.btn-outline-success {
    border-color: #198754;
    color: #20c997;
    transition: all 0.3s ease;
}

.btn-outline-success:hover {
    background-color: #198754;
    color: #ffffff;
    box-shadow: 0 4px 8px rgba(25, 135, 84, 0.3);
    transform: translateY(-1px);
}

.btn-outline-info {
    border-color: #0dcaf0;
    color: #0dcaf0;
    transition: all 0.3s ease;
}

.btn-outline-info:hover {
    background-color: #0dcaf0;
    color: #000000;
    box-shadow: 0 4px 8px rgba(13, 202, 240, 0.3);
    transform: translateY(-1px);
}

/* ========== VISTA MÓVIL ========== */
@media (max-width: 575.98px) {
    /* Mobile */
    .d-flex.flex-wrap.gap-2.justify-content-end {
        justify-content: flex-end !important;
        align-items: flex-end !important;
    }
    
    .btn-sm {
        font-size: 0.75rem;
        padding: 0.35rem 0.65rem;
        white-space: nowrap;
    }
    
    .h4 {
        font-size: 1.2rem;
    }
    
    .h5 {
        font-size: 1.1rem;
    }
    
    .badge-lg {
        font-size: 0.7rem;
        padding: 0.35rem 0.5rem;
    }
    
    .card-header h5 {
        font-size: 0.95rem;
    }
    
    .card-header h6 {
        font-size: 0.85rem;
    }
    
    .h6 {
        font-size: 0.9rem;
    }
    
    .comprobante-img {
        max-height: 200px;
    }
    
    /* Ajustes para las tarjetas de pago en móvil */
    .card.bg-secondary .card-header {
        padding: 0.75rem;
    }
    
    .card.bg-secondary .card-body {
        padding: 0.75rem;
    }
    
    .mb-2 {
        margin-bottom: 0.75rem !important;
    }
    
    /* Mejoras para badges en móvil */
    .badge {
        font-size: 0.7rem;
        padding: 0.35em 0.6em;
        display: inline-block;
        margin: 0.15rem 0.15rem 0.15rem 0;
    }
    
    /* Ajustar gap en móvil */
    .d-flex.gap-2 {
        gap: 0.35rem !important;
    }
    
    /* Botones en móvil ocupan todo el ancho disponible */
    .d-flex.gap-2.flex-wrap .btn {
        flex: 1 1 auto;
        min-width: fit-content;
    }
    
    /* Texto más pequeño en móvil */
    small {
        font-size: 0.75rem;
    }
    
    .text-muted.small {
        font-size: 0.7rem;
    }
}

@media (min-width: 576px) and (max-width: 767.98px) {
    /* Tablet */
    .btn-sm {
        font-size: 0.8rem;
        padding: 0.4rem 0.75rem;
    }
    
    .comprobante-img {
        max-height: 250px;
    }
    
    .card.bg-secondary .card-body {
        padding: 1rem;
    }
}

@media (min-width: 768px) and (max-width: 991.98px) {
    /* Tablet grande */
    .comprobante-img {
        max-height: 300px;
    }
}

@media (min-width: 992px) {
    /* Desktop */
    .comprobante-img {
        max-height: 400px;
    }
}

/* Fix para botones en mobile - asegurar que estén a la derecha */
@media (max-width: 575.98px) {
    .d-flex.flex-wrap.gap-2 {
        justify-content: flex-end !important;
        margin-left: auto !important;
    }
    
    /* Mejorar espaciado en tarjetas de pago móvil */
    .card.bg-secondary {
        margin-bottom: 1rem;
    }
}

/* ========== TRANSICIONES Y ANIMACIONES ========== */
.card, .btn, .badge {
    transition: all 0.3s ease;
}

/* ========== ICONOS ========== */
.fas, .fa {
    margin-right: 0.35rem;
}

/* ========== MEJORAS VISUALES ========== */
.border-secondary {
    border-color: rgba(255, 255, 255, 0.1) !important;
}

hr.border-secondary {
    opacity: 0.2;
}

/* Enlaces mejorados */
a.text-info {
    color: #0dcaf0 !important;
    text-decoration: none;
    transition: all 0.2s ease;
}

a.text-info:hover {
    color: #31d2f2 !important;
    text-decoration: underline;
}

/* Alertas */
.alert-info {
    background-color: rgba(13, 202, 240, 0.1);
    border-color: rgba(13, 202, 240, 0.3);
    color: #0dcaf0;
}
</style>

<script id="monedas-data" type="application/json">
{% if monedas_data_json %}{{ monedas_data_json|safe }}{% else %}{}{% endif %}
</script>

<script>

// Variable global para prevenir múltiples envíos
let isProcessing = false;

// Función para obtener CSRF token
function getCSRFToken() {
    // Intentar obtener del input hidden
    let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        return csrfToken.value;
    }
    
    // Intentar obtener del meta tag
    let csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        return csrfMeta.getAttribute('content');
    }
    
    // Intentar obtener de las cookies
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, 10) === 'csrftoken=') {
                cookieValue = decodeURIComponent(cookie.substring(10));
                break;
            }
        }
    }
    return cookieValue;
}

// Función para deshabilitar/habilitar todos los botones de acción
function toggleActionButtons(disabled) {
    const actionButtons = document.querySelectorAll('.btn-confirmar-remesa, .btn-cancelar-remesa, .btn-eliminar-remesa, .btn-reactivar-remesa');
    actionButtons.forEach(btn => {
        btn.disabled = disabled;
        if (disabled) {
            btn.classList.add('disabled');
            btn.style.pointerEvents = 'none';
        } else {
            btn.classList.remove('disabled');
            btn.style.pointerEvents = 'auto';
        }
    });
}

// Función para enviar petición AJAX con protección contra doble envío
function sendAjaxRequest(url, remesaId, actionType) {
    // Verificar si ya hay una petición en proceso
    if (isProcessing) {
        Swal.fire({
            title: 'Operación en Proceso',
            text: 'Ya hay una operación en curso. Por favor espere.',
            icon: 'warning',
            background: '#343a40',
            color: '#ffffff',
            confirmButtonColor: '#ffc107'
        });
        return;
    }
    
    // Marcar como procesando y deshabilitar botones
    isProcessing = true;
    toggleActionButtons(true);
    
    const csrfToken = getCSRFToken();
    
    // Mostrar loading
    Swal.fire({
        title: 'Procesando...',
        text: `Ejecutando acción: ${actionType}`,
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        background: '#343a40',
        color: '#ffffff',
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    fetch(url.replace('0', remesaId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        Swal.close();
        
        if (data.success) {
            // Éxito - mostrar mensaje y recargar página
            Swal.fire({
                title: '¡Éxito!',
                text: data.message,
                icon: 'success',
                background: '#343a40',
                color: '#ffffff',
                confirmButtonColor: '#28a745',
                allowOutsideClick: false
            }).then(() => {
                // Si el backend manda redirect_url, navegar; si no, recargar.
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    window.location.reload();
                }
            });
        } else {
            // Error - mostrar mensaje de error y rehabilitar botones
            isProcessing = false;
            toggleActionButtons(false);
            
            Swal.fire({
                title: 'Error',
                text: data.message || 'Ocurrió un error al procesar la solicitud',
                icon: 'error',
                background: '#343a40',
                color: '#ffffff',
                confirmButtonColor: '#dc3545'
            });
        }
    })
    .catch(error => {
        Swal.close();
        isProcessing = false;
        toggleActionButtons(false);
        
        console.error('Error:', error);
        Swal.fire({
            title: 'Error de Conexión',
            text: 'Hubo un problema al procesar la solicitud. Por favor, inténtelo de nuevo.',
            icon: 'error',
            background: '#343a40',
            color: '#ffffff',
            confirmButtonColor: '#dc3545'
        });
    });
}

// Función para mostrar comprobante en modal
function mostrarComprobanteCompleto(imageUrl) {
    document.getElementById('modalComprobanteImage').src = imageUrl;
    document.getElementById('comprobanteDownloadLink').href = imageUrl;
    var modal = new bootstrap.Modal(document.getElementById('comprobanteModal'));
    modal.show();
}

// Funciones para las acciones de remesa
document.addEventListener('DOMContentLoaded', function() {
    // Confirmar remesa
    const btnsConfirmar = document.querySelectorAll('.btn-confirmar-remesa');
    btnsConfirmar.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Verificar si ya está procesando
            if (isProcessing) {
                return;
            }
            
            const remesaId = this.dataset.remesaId;
            const remesaNumero = this.dataset.remesaNumero;
            
            Swal.fire({
                title: '¿Confirmar Remesa?',
                text: `¿Está seguro que desea confirmar la remesa #${remesaNumero}? Esta acción afectará el balance del gestor.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, confirmar',
                cancelButtonText: 'Cancelar',
                background: '#343a40',
                color: '#ffffff',
                allowOutsideClick: false
            }).then((result) => {
                if (result.isConfirmed) {
                    sendAjaxRequest('{% url "remesas:confirmar_remesa" 0 %}', remesaId, 'confirmar');
                }
            });
        });
    });

    // Cancelar remesa
    const btnsCancelar = document.querySelectorAll('.btn-cancelar-remesa');
    btnsCancelar.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Verificar si ya está procesando
            if (isProcessing) {
                return;
            }
            
            const remesaId = this.dataset.remesaId;
            const remesaNumero = this.dataset.remesaNumero;
            
            Swal.fire({
                title: '¿Cancelar Remesa?',
                text: `¿Está seguro que desea cancelar la remesa #${remesaNumero}? Esta acción no se puede deshacer.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, cancelar',
                cancelButtonText: 'No, mantener',
                background: '#343a40',
                color: '#ffffff',
                allowOutsideClick: false
            }).then((result) => {
                if (result.isConfirmed) {
                    sendAjaxRequest('{% url "remesas:cancelar_remesa" 0 %}', remesaId, 'cancelar');
                }
            });
        });
    });

    // Eliminar remesa
    const btnsEliminar = document.querySelectorAll('.btn-eliminar-remesa');
    btnsEliminar.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Verificar si ya está procesando
            if (isProcessing) {
                return;
            }
            
            const remesaId = this.dataset.remesaId;
            const remesaNumero = this.dataset.remesaNumero;
            
            Swal.fire({
                title: '¿Eliminar Remesa?',
                text: `¿Está seguro que desea eliminar permanentemente la remesa #${remesaNumero}? Esta acción revertirá el balance del gestor y no se puede deshacer.`,
                icon: 'error',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar',
                background: '#343a40',
                color: '#ffffff',
                allowOutsideClick: false
            }).then((result) => {
                if (result.isConfirmed) {
                    sendAjaxRequest('{% url "remesas:eliminar_remesa" 0 %}', remesaId, 'eliminar');
                }
            });
        });
    });

    // Reactivar remesa (cancelada por tiempo)
    const btnsReactivar = document.querySelectorAll('.btn-reactivar-remesa');
    btnsReactivar.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();

            if (isProcessing) {
                return;
            }

            const remesaId = this.dataset.remesaId;
            const remesaNumero = this.dataset.remesaNumero;

            Swal.fire({
                title: '¿Reactivar Remesa?',
                text: `Se creará una NUEVA remesa basada en #${remesaNumero} y el contador de 23/24h se reiniciará.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#17a2b8',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, reactivar',
                cancelButtonText: 'Cancelar',
                background: '#343a40',
                color: '#ffffff',
                allowOutsideClick: false
            }).then((result) => {
                if (result.isConfirmed) {
                    sendAjaxRequest('{% url "remesas:reactivar_remesa" 0 %}', remesaId, 'reactivar');
                }
            });
        });
    });
    
    // Protección adicional: deshabilitar botones si la página se está recargando
    window.addEventListener('beforeunload', function() {
        isProcessing = true;
        toggleActionButtons(true);
    });
    
    // ============ FUNCIONALIDAD DE PAGOS DE REMESA ============
    
    // Mostrar/Ocultar formulario de pago
    const btnMostrarFormulario = document.getElementById('btnMostrarFormularioPago');
    const btnCerrarFormulario = document.getElementById('btnCerrarFormularioPago');
    const btnCancelarPago = document.getElementById('btnCancelarPago');
    const formularioPagoRemesa = document.getElementById('formularioPagoRemesa');
    const formPagoRemesa = document.getElementById('formPagoRemesa');
    
    if (btnMostrarFormulario) {
        btnMostrarFormulario.addEventListener('click', function() {
            formularioPagoRemesa.style.display = 'block';
            this.style.display = 'none';
        });
    }
    
    function ocultarFormularioPago() {
        if (formularioPagoRemesa) {
            formularioPagoRemesa.style.display = 'none';
        }
        if (btnMostrarFormulario) {
            btnMostrarFormulario.style.display = 'inline-block';
        }
        if (formPagoRemesa) {
            formPagoRemesa.reset();
            // Limpiar mensajes de error
            const invalidFeedbacks = formPagoRemesa.querySelectorAll('.invalid-feedback');
            invalidFeedbacks.forEach(feedback => {
                feedback.textContent = '';
                feedback.style.display = 'none';
            });
            const inputs = formPagoRemesa.querySelectorAll('.is-invalid');
            inputs.forEach(input => input.classList.remove('is-invalid'));
        }
    }
    
    if (btnCerrarFormulario) {
        btnCerrarFormulario.addEventListener('click', ocultarFormularioPago);
    }
    
    if (btnCancelarPago) {
        btnCancelarPago.addEventListener('click', ocultarFormularioPago);
    }
    
    // Manejar cambio de tipo de pago (mostrar/ocultar campos)
    const tipoPagoSelect = document.getElementById('id_tipo_pago');
    const divTarjeta = document.getElementById('div_tarjeta');
    const divTelefono = document.getElementById('div_telefono');
    const divDireccion = document.getElementById('div_direccion');
    
    if (tipoPagoSelect) {
        tipoPagoSelect.addEventListener('change', function() {
            if (this.value === 'transferencia') {
                divTarjeta.style.display = 'block';
                document.getElementById('telefono_required').style.display = 'none';
                document.getElementById('direccion_required').style.display = 'none';
            } else if (this.value === 'efectivo') {
                divTarjeta.style.display = 'none';
                document.getElementById('telefono_required').style.display = 'inline';
                document.getElementById('direccion_required').style.display = 'inline';
            }
        });
    }
    
    // Calcular y mostrar monto en USD y balance resultante
    let monedasData = {};
    const monedasDataEl = document.getElementById('monedas-data');
    if (monedasDataEl) {
        try {
            monedasData = JSON.parse(monedasDataEl.textContent || '{}');
        } catch (error) {
            console.error('Error parseando monedas_data_json:', error);
            monedasData = {};
        }
    }
    const balanceActual = parseFloat('{{ user_balance|default:"0" }}'.replace(',', '.')) || 0;
    const cantidadInput = document.getElementById('id_cantidad');
    const monedaSelect = document.getElementById('id_tipo_moneda');
    
    function calcularYMostrarBalance() {
        const cantidad = parseFloat(cantidadInput.value);
        const monedaId = monedaSelect.value;
        
        if (cantidad && cantidad > 0 && monedaId && monedasData[monedaId]) {
            const monedaInfo = monedasData[monedaId];
            let montoUSD = 0;
            
            // Calcular monto en USD
            if (monedaInfo.codigo === 'USD') {
                montoUSD = cantidad;
            } else {
                if (monedaInfo.valor_usuario && monedaInfo.valor_usuario > 0) {
                    montoUSD = cantidad / monedaInfo.valor_usuario;
                }
            }
            
            // Calcular balance resultante
            const balanceResultante = balanceActual - montoUSD;
            
            // Mostrar el cálculo
            let calculoDiv = document.getElementById('calculo-usd-remesa');
            if (!calculoDiv) {
                calculoDiv = document.createElement('div');
                calculoDiv.id = 'calculo-usd-remesa';
                calculoDiv.className = 'alert mt-2';
                cantidadInput.parentElement.appendChild(calculoDiv);
            }
            
            let mensaje = '<strong>Balance actual:</strong> $' + balanceActual.toFixed(2) + ' USD<br>';
            mensaje += '<strong>Monto del pago:</strong> $' + montoUSD.toFixed(2) + ' USD<br>';
            mensaje += '<strong>Balance después del pago:</strong> $' + balanceResultante.toFixed(2) + ' USD';
            
            if (balanceResultante < 0) {
                calculoDiv.className = 'alert alert-warning mt-2';
                mensaje += '<br><span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>El balance resultará negativo</span>';
            } else {
                calculoDiv.className = 'alert alert-info mt-2';
            }
            
            calculoDiv.innerHTML = mensaje;
        } else {
            const calculoDiv = document.getElementById('calculo-usd-remesa');
            if (calculoDiv) {
                calculoDiv.remove();
            }
        }
    }
    
    if (cantidadInput && monedaSelect) {
        cantidadInput.addEventListener('input', calcularYMostrarBalance);
        monedaSelect.addEventListener('change', calcularYMostrarBalance);
    }
    
    // Enviar formulario de pago
    if (formPagoRemesa) {
        formPagoRemesa.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (isProcessing) {
                Swal.fire({
                    title: 'Procesando',
                    text: 'Por favor espere...',
                    icon: 'info',
                    background: '#343a40',
                    color: '#ffffff'
                });
                return;
            }
            
            isProcessing = true;
            const btnGuardar = document.getElementById('btnGuardarPago');
            const originalText = btnGuardar.innerHTML;
            btnGuardar.disabled = true;
            btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Guardando...';
            
            // Crear FormData con los datos del formulario
            const formData = new FormData(this);
            
            // Enviar petición AJAX
            fetch('{% url "remesas:crear_pago_remesa" remesa.id %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                isProcessing = false;
                btnGuardar.disabled = false;
                btnGuardar.innerHTML = originalText;
                
                if (data.success) {
                    Swal.fire({
                        title: '¡Éxito!',
                        text: data.message,
                        icon: 'success',
                        background: '#343a40',
                        color: '#ffffff',
                        confirmButtonColor: '#28a745'
                    }).then(() => {
                        // Recargar la página para mostrar el nuevo pago
                        window.location.reload();
                    });
                } else {
                    // Mostrar errores del formulario
                    if (data.errors) {
                        // Limpiar errores previos
                        const invalidFeedbacks = formPagoRemesa.querySelectorAll('.invalid-feedback');
                        invalidFeedbacks.forEach(feedback => {
                            feedback.textContent = '';
                            feedback.style.display = 'none';
                        });
                        const inputs = formPagoRemesa.querySelectorAll('.is-invalid');
                        inputs.forEach(input => input.classList.remove('is-invalid'));
                        
                        // Mostrar nuevos errores
                        for (const [field, errors] of Object.entries(data.errors)) {
                            const input = document.getElementById(`id_${field}`);
                            if (input) {
                                input.classList.add('is-invalid');
                                const feedback = input.parentElement.querySelector('.invalid-feedback');
                                if (feedback) {
                                    feedback.textContent = errors.join(', ');
                                    feedback.style.display = 'block';
                                }
                            }
                        }
                    }
                    
                    Swal.fire({
                        title: 'Error',
                        text: data.message,
                        icon: 'error',
                        background: '#343a40',
                        color: '#ffffff',
                        confirmButtonColor: '#dc3545'
                    });
                }
            })
            .catch(error => {
                isProcessing = false;
                btnGuardar.disabled = false;
                btnGuardar.innerHTML = originalText;
                
                Swal.fire({
                    title: 'Error',
                    text: 'Error al enviar el formulario: ' + error.message,
                    icon: 'error',
                    background: '#343a40',
                    color: '#ffffff',
                    confirmButtonColor: '#dc3545'
                });
            });
        });
    }
});

// Manejador de eventos delegado para botones de pagos de remesa (fuera del DOMContentLoaded para asegurar que siempre se cargue)

document.addEventListener('click', function(e) {
    // Confirmar pago de remesa
    const btnConfirmar = e.target.closest('.btn-confirmar-pago-remesa');
    if (btnConfirmar) {
        e.preventDefault();
        e.stopPropagation();
        
        const pagoId = btnConfirmar.getAttribute('data-pago-id');
        const pagoNumero = btnConfirmar.getAttribute('data-pago-numero');
        
        if (!pagoId || !pagoNumero) {
            console.error('Faltan datos del pago');
            Swal.fire({
                title: 'Error',
                text: 'No se pudieron obtener los datos del pago',
                icon: 'error',
                background: '#343a40',
                color: '#ffffff'
            });
            return;
        }
        
        Swal.fire({
            title: '¿Confirmar Pago?',
            text: `¿Está seguro que desea confirmar el pago ${pagoNumero}? Esta acción deducirá el monto del balance del usuario.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sí, confirmar',
            cancelButtonText: 'Cancelar',
            background: '#343a40',
            color: '#ffffff'
        }).then((result) => {
            if (result.isConfirmed) {
                const url = `/remesas/pagos-remesa/confirmar/${pagoId}/`;
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: '¡Confirmado!',
                            text: data.message,
                            icon: 'success',
                            background: '#343a40',
                            color: '#ffffff',
                            confirmButtonColor: '#28a745'
                        }).then(() => {
                            window.location.reload();
                        });
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: data.message,
                            icon: 'error',
                            background: '#343a40',
                            color: '#ffffff',
                            confirmButtonColor: '#dc3545'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error en petición:', error);
                    Swal.fire({
                        title: 'Error',
                        text: 'Error al confirmar el pago: ' + error.message,
                        icon: 'error',
                        background: '#343a40',
                        color: '#ffffff',
                        confirmButtonColor: '#dc3545'
                    });
                });
            }
        });
        return;
    }
    
    // Cancelar pago de remesa
    const btnCancelar = e.target.closest('.btn-cancelar-pago-remesa');
    if (btnCancelar) {
        e.preventDefault();
        e.stopPropagation();
        
        const pagoId = btnCancelar.getAttribute('data-pago-id');
        const pagoNumero = btnCancelar.getAttribute('data-pago-numero');
        
        Swal.fire({
            title: '¿Cancelar Pago?',
            text: `¿Está seguro que desea cancelar el pago ${pagoNumero}? Esta acción no se puede deshacer.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sí, cancelar',
            cancelButtonText: 'No',
            background: '#343a40',
            color: '#ffffff'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/remesas/pagos-remesa/cancelar/${pagoId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: '¡Cancelado!',
                            text: data.message,
                            icon: 'success',
                            background: '#343a40',
                            color: '#ffffff',
                            confirmButtonColor: '#28a745'
                        }).then(() => {
                            window.location.reload();
                        });
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: data.message,
                            icon: 'error',
                            background: '#343a40',
                            color: '#ffffff',
                            confirmButtonColor: '#dc3545'
                        });
                    }
                })
                .catch(error => {
                    Swal.fire({
                        title: 'Error',
                        text: 'Error al cancelar el pago: ' + error.message,
                        icon: 'error',
                        background: '#343a40',
                        color: '#ffffff',
                        confirmButtonColor: '#dc3545'
                    });
                });
            }
        });
        return;
    }

    // Reactivar pago de remesa (cancelado por tiempo)
    const btnReactivarPago = e.target.closest('.btn-reactivar-pago-remesa');
    if (btnReactivarPago) {
        e.preventDefault();
        e.stopPropagation();

        const pagoId = btnReactivarPago.getAttribute('data-pago-id');
        const pagoNumero = btnReactivarPago.getAttribute('data-pago-numero');

        Swal.fire({
            title: '¿Reactivar Pago?',
            text: `Se creará un NUEVO pago basado en ${pagoNumero} y el contador de 23/24h se reiniciará.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#17a2b8',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sí, reactivar',
            cancelButtonText: 'Cancelar',
            background: '#343a40',
            color: '#ffffff'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/remesas/pagos-remesa/reactivar/${pagoId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: '¡Reactivado!',
                            text: data.message,
                            icon: 'success',
                            background: '#343a40',
                            color: '#ffffff',
                            confirmButtonColor: '#28a745'
                        }).then(() => {
                            if (data.redirect_url) {
                                window.location.href = data.redirect_url;
                            } else {
                                window.location.reload();
                            }
                        });
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: data.message,
                            icon: 'error',
                            background: '#343a40',
                            color: '#ffffff',
                            confirmButtonColor: '#dc3545'
                        });
                    }
                })
                .catch(error => {
                    Swal.fire({
                        title: 'Error',
                        text: 'Error al reactivar el pago: ' + error.message,
                        icon: 'error',
                        background: '#343a40',
                        color: '#ffffff',
                        confirmButtonColor: '#dc3545'
                    });
                });
            }
        });
        return;
    }
    
    // Eliminar pago de remesa
    const btnEliminar = e.target.closest('.btn-eliminar-pago-remesa');
    if (btnEliminar) {
        e.preventDefault();
        e.stopPropagation();
        
        const pagoId = btnEliminar.getAttribute('data-pago-id');
        const pagoNumero = btnEliminar.getAttribute('data-pago-numero');
        
        Swal.fire({
            title: '¿Eliminar Pago?',
            text: `¿Está seguro que desea eliminar el pago ${pagoNumero}?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar',
            background: '#343a40',
            color: '#ffffff'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/remesas/pagos-remesa/eliminar/${pagoId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: '¡Eliminado!',
                            text: data.message,
                            icon: 'success',
                            background: '#343a40',
                            color: '#ffffff',
                            confirmButtonColor: '#28a745'
                        }).then(() => {
                            window.location.reload();
                        });
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: data.message,
                            icon: 'error',
                            background: '#343a40',
                            color: '#ffffff',
                            confirmButtonColor: '#dc3545'
                        });
                    }
                })
                .catch(error => {
                    Swal.fire({
                        title: 'Error',
                        text: 'Error al eliminar el pago: ' + error.message,
                        icon: 'error',
                        background: '#343a40',
                        color: '#ffffff',
                        confirmButtonColor: '#dc3545'
                    });
                });
            }
        });
        return;
    }
});
</script>

{% endblock %}