{% extends 'eglisapp/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card bg-dark text-white">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0">
                            <i class="fas fa-edit me-2"></i>
                            Editar Pago de Remesa
                        </h3>
                        <small class="text-muted">ID: {{ pago.pago_id }} - Remesa: {{ remesa.remesa_id }}</small>
                    </div>
                    <div class="btn-group">
                        <a href="{% url 'remesas:detalle_remesa' remesa.id %}" class="btn btn-outline-light">
                            <i class="fas fa-arrow-left me-2"></i>Volver a Remesa
                        </a>
                    </div>
                </div>

                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}

                        {% if is_admin_user %}
                            {{ pago.usuario.id|json_script:"pago-remesa-usuario-id" }}
                            {{ pago.tipo_moneda.id|json_script:"pago-remesa-moneda-id" }}
                            <div class="mb-3">
                                <label for="usuario_asignado" class="form-label">Crear a nombre de *</label>
                                <select class="form-control bg-dark text-white border-secondary" id="usuario_asignado" name="usuario_asignado" required>
                                    <option value="">Cargando usuarios...</option>
                                </select>
                                <small class="text-muted">Este usuario será el dueño del pago enlazado.</small>
                            </div>
                        {% else %}
                            {{ pago.usuario.id|json_script:"pago-remesa-usuario-id" }}
                            {{ pago.tipo_moneda.id|json_script:"pago-remesa-moneda-id" }}
                        {% endif %}
                        
                        <!-- Información básica del Pago -->
                        <div class="row">
                            <div class="col-12">
                                <h5 class="text-info border-bottom pb-2 mb-3">
                                    <i class="fas fa-credit-card me-2"></i>Información del Pago
                                </h5>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.destinatario.id_for_label }}" class="form-label">
                                        {{ form.destinatario.label }}
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.destinatario }}
                                    {% if form.destinatario.errors %}
                                        <div class="text-danger small">{{ form.destinatario.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.cantidad.id_for_label }}" class="form-label">
                                        {{ form.cantidad.label }}
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.cantidad }}
                                    {% if form.cantidad.errors %}
                                        <div class="text-danger small">{{ form.cantidad.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.tipo_moneda.id_for_label }}" class="form-label">
                                        {{ form.tipo_moneda.label }}
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.tipo_moneda }}
                                    {% if form.tipo_moneda.errors %}
                                        <div class="text-danger small">{{ form.tipo_moneda.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.tipo_pago.id_for_label }}" class="form-label">
                                        {{ form.tipo_pago.label }}
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.tipo_pago }}
                                    {% if form.tipo_pago.errors %}
                                        <div class="text-danger small">{{ form.tipo_pago.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.telefono.id_for_label }}" class="form-label">
                                        {{ form.telefono.label }}
                                    </label>
                                    {{ form.telefono }}
                                    {% if form.telefono.errors %}
                                        <div class="text-danger small">{{ form.telefono.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.carnet_identidad.id_for_label }}" class="form-label">
                                        {{ form.carnet_identidad.label }}
                                    </label>
                                    {{ form.carnet_identidad }}
                                    {% if form.carnet_identidad.errors %}
                                        <div class="text-danger small">{{ form.carnet_identidad.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3" id="campo_tarjeta">
                                    <label for="{{ form.tarjeta.id_for_label }}" class="form-label">
                                        {{ form.tarjeta.label }}
                                    </label>
                                    {{ form.tarjeta }}
                                    {% if form.tarjeta.errors %}
                                        <div class="text-danger small">{{ form.tarjeta.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.direccion.id_for_label }}" class="form-label">
                                        {{ form.direccion.label }}
                                    </label>
                                    {{ form.direccion }}
                                    {% if form.direccion.errors %}
                                        <div class="text-danger small">{{ form.direccion.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Campos adicionales -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.observaciones.id_for_label }}" class="form-label">
                                        {{ form.observaciones.label }}
                                    </label>
                                    {{ form.observaciones }}
                                    {% if form.observaciones.errors %}
                                        <div class="text-danger small">{{ form.observaciones.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.comprobante_pago.id_for_label }}" class="form-label">
                                        {{ form.comprobante_pago.label }}
                                    </label>
                                    {% if pago.comprobante_pago %}
                                        <div class="mb-2">
                                            <img src="{{ pago.comprobante_pago.url }}" alt="Comprobante actual" 
                                                 class="img-thumbnail" style="max-width: 150px; cursor: pointer;"
                                                 data-bs-toggle="modal" data-bs-target="#comprobanteModal">
                                            <small class="text-muted d-block">Archivo actual (click para ver)</small>
                                        </div>
                                    {% endif %}
                                    {{ form.comprobante_pago }}
                                    <small class="text-muted d-block">Deje vacío para mantener el comprobante actual</small>
                                    {% if form.comprobante_pago.errors %}
                                        <div class="text-danger small">{{ form.comprobante_pago.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Botones -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'remesas:detalle_remesa' remesa.id %}" class="btn btn-outline-light">
                                <i class="fas fa-arrow-left me-2"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver comprobante -->
{% if pago.comprobante_pago %}
<div class="modal fade" id="comprobanteModal" tabindex="-1" aria-labelledby="comprobanteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white" id="comprobanteModalLabel">Comprobante de Pago</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img src="{{ pago.comprobante_pago.url }}" alt="Comprobante" class="img-fluid rounded">
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <a href="{{ pago.comprobante_pago.url }}" download class="btn btn-primary">
                    <i class="fas fa-download me-2"></i>Descargar
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tipoPagoSelect = document.getElementById('{{ form.tipo_pago.id_for_label }}');
    const campoTarjeta = document.getElementById('campo_tarjeta');
    const tarjetaInput = document.getElementById('{{ form.tarjeta.id_for_label }}');
    const usuarioAsignadoSelect = document.getElementById('usuario_asignado');
    const tipoMonedaSelect = document.getElementById('{{ form.tipo_moneda.id_for_label }}');

    const pagoUsuarioIdEl = document.getElementById('pago-remesa-usuario-id');
    const pagoMonedaIdEl = document.getElementById('pago-remesa-moneda-id');
    const pagoUsuarioId = pagoUsuarioIdEl ? JSON.parse(pagoUsuarioIdEl.textContent) : null;
    const pagoMonedaId = pagoMonedaIdEl ? JSON.parse(pagoMonedaIdEl.textContent) : null;

    function cargarUsuariosAsignados() {
        if (!usuarioAsignadoSelect) return;

        fetch('/remesas/api/gestores/')
            .then(r => r.json())
            .then(data => {
                usuarioAsignadoSelect.innerHTML = '<option value="">Elegir</option>';
                data.forEach(u => {
                    const option = document.createElement('option');
                    option.value = u.id;
                    option.textContent = u.nombre;
                    if (pagoUsuarioId && String(u.id) === String(pagoUsuarioId)) {
                        option.selected = true;
                    }
                    usuarioAsignadoSelect.appendChild(option);
                });
            })
            .catch(err => {
                console.error('Error cargando usuarios:', err);
                usuarioAsignadoSelect.innerHTML = '<option value="">Error cargando usuarios</option>';
            });
    }

    function cargarMonedas() {
        if (!tipoMonedaSelect || !tipoPagoSelect) return;
        const tipoMoneda = tipoPagoSelect.value || '';
        if (!tipoMoneda) return;

        const usuarioId = usuarioAsignadoSelect ? (usuarioAsignadoSelect.value || '') : '';
        let url = `/remesas/api/monedas/?tipo_moneda=${encodeURIComponent(tipoMoneda)}`;
        if (usuarioId) {
            url += `&usuario_id=${encodeURIComponent(usuarioId)}`;
        }

        fetch(url)
            .then(r => r.json())
            .then(data => {
                const current = tipoMonedaSelect.value || (pagoMonedaId ? String(pagoMonedaId) : '');
                tipoMonedaSelect.innerHTML = '<option value="">Seleccione una moneda</option>';
                data.forEach(moneda => {
                    const option = document.createElement('option');
                    option.value = moneda.id;
                    option.textContent = `${moneda.nombre} (${moneda.codigo})`;
                    if (current && String(moneda.id) === String(current)) {
                        option.selected = true;
                    }
                    tipoMonedaSelect.appendChild(option);
                });
            })
            .catch(err => console.error('Error cargando monedas:', err));
    }
    
    // Función para mostrar/ocultar campo de tarjeta
    function toggleTarjetaField() {
        if (tipoPagoSelect.value === 'transferencia') {
            campoTarjeta.style.display = 'block';
            tarjetaInput.required = true;
        } else {
            campoTarjeta.style.display = 'none';
            tarjetaInput.required = false;
        }
    }
    
    // Configurar visibilidad inicial
    toggleTarjetaField();

    // Cargar usuarios (si aplica) y monedas con filtros por usuario/tipo
    cargarUsuariosAsignados();
    cargarMonedas();

    if (usuarioAsignadoSelect) {
        usuarioAsignadoSelect.addEventListener('change', cargarMonedas);
    }
    
    // Escuchar cambios en tipo de pago
    tipoPagoSelect.addEventListener('change', function() {
        toggleTarjetaField();
        cargarMonedas();
    });
});
</script>

<style>
/* Estilos para formularios */
.form-control, .form-select {
    background-color: #212529 !important;
    border-color: #495057 !important;
    color: #fff !important;
}

.form-control:focus, .form-select:focus {
    background-color: #2d3238 !important;
    border-color: #0d6efd !important;
    color: #fff !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

textarea.form-control {
    resize: vertical;
}

.form-label {
    color: #adb5bd;
    font-weight: 500;
}

.text-danger {
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.img-thumbnail {
    background-color: #343a40;
    border-color: #495057;
}

.btn-group .btn {
    margin-left: 0.5rem;
}

/* Mejorar el espaciado en móvil */
@media (max-width: 768px) {
    .card-header .btn-group {
        flex-direction: column;
        width: 100%;
    }
    
    .card-header .btn-group .btn {
        margin-left: 0;
        margin-top: 0.5rem;
        width: 100%;
    }
    
    .d-flex.justify-content-between {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .d-flex.justify-content-between .btn {
        width: 100%;
    }
}
</style>
{% endblock %}
