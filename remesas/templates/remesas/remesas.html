{% extends 'eglisapp/base.html' %}
{% load static %}
{% block content %}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
            <div class="card bg-dark border-secondary">
                <div class="card-body">
                    <h4 class="text-white mb-4 text-center">
                        <i class="fas fa-credit-card mr-2"></i>
                        Recibir
                    </h4>

                    <form id="formRemesa" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Datos principales -->
                        <input type="hidden" id="remesa_id" name="remesa_id">
                        <input type="hidden" id="fecha" name="fecha">
                        
                        <!-- Datos de la remesa -->
                        <div class="mb-4">
                            <div class="form-group mb-3">
                                <label for="tipo_pago" class="form-label text-white">Tipo de Pago</label>
                                <select class="form-select bg-dark text-white border-secondary" 
                                        id="tipo_pago" 
                                        name="tipo_pago"
                                        required>
                                    <option value="">Seleccionar tipo de pago...</option>
                                    <option value="transferencia">Transferencia</option>
                                    <option value="efectivo">Efectivo</option>
                                </select>
                            </div>

                            <div class="form-group mb-3">
                                <label for="moneda" class="form-label text-white">Moneda</label>
                                <select class="form-select bg-dark text-white border-secondary" 
                                        id="moneda" 
                                        name="moneda"
                                        required>
                                    <option value="">Seleccionar moneda...</option>
                                </select>
                            </div>

                            <div class="form-group mb-3">
                                <label for="importe" class="form-label text-white">Importe</label>
                                <input type="number" 
                                       class="form-control bg-dark text-white border-secondary" 
                                       id="importe" 
                                       name="importe" 
                                       step="0.01" 
                                       required>
                            </div>
                        </div>

                        <!-- Remitente -->
                        <div class="mb-4">
                            <h6 class="text-white mb-3">Remitente</h6>
                            <div class="form-group">
                                <input type="text" 
                                       class="form-control bg-dark text-white border-secondary" 
                                       id="receptor_nombre" 
                                       name="receptor_nombre" 
                                       placeholder="Nombre completo del remitente"
                                       required>
                            </div>
                        </div>

                        <!-- Observaciones -->
                        <div class="mb-4">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="check_observaciones">
                                <label class="form-check-label text-white" for="check_observaciones">
                                    <i class="fas fa-sticky-note me-2"></i>Agregar observaciones
                                </label>
                            </div>
                            <div id="campo_observaciones" class="form-group" style="display: none;">
                                <label for="observaciones" class="form-label text-white">Observaciones</label>
                                <textarea class="form-control bg-dark text-white border-secondary" 
                                          id="observaciones" 
                                          name="observaciones" 
                                          rows="3"
                                          placeholder="Observaciones adicionales"></textarea>
                            </div>
                        </div>

                        <!-- Comprobante -->
                        <div class="mb-4">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="check_comprobante">
                                <label class="form-check-label text-white" for="check_comprobante">
                                    <i class="fas fa-file-image me-2"></i>Subir comprobante
                                </label>
                            </div>
                            <div id="campo_comprobante" class="form-group" style="display: none;">
                                <label for="comprobante" class="form-label text-white">Comprobante</label>
                                <input type="file" 
                                       class="form-control bg-dark text-white border-secondary" 
                                       id="comprobante" 
                                       name="comprobante" 
                                       accept="image/*">
                                <small class="form-text text-muted">Suba una imagen del comprobante</small>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="{% url 'remesas:registro_transacciones' %}" class="btn btn-outline-light">
                                <i class="fas fa-arrow-left me-2"></i>Volver
                            </a>
                            <button type="submit" class="btn btn-primary" id="btnGuardarRemesa">
                                <i class="fas fa-paper-plane me-2" id="btnIcono"></i>
                                <span id="btnTexto">Enviar Remesa</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Django context data -->
{{ user.id|json_script:"user-id" }}

<!-- Datos de monedas y balance -->
<script id="monedas-data" type="application/json">
    {{ monedas_json|safe }}
</script>

<script id="user-balance" type="application/json">
    {{ user_balance|safe }}
</script>

<style>
/* Estilos minimalistas */
.form-control, .form-select {
    background-color: #1a1a1a !important;
    border: 1px solid #333;
    color: #fff !important;
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 10px;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: none;
}

/* Estilos específicos para textarea */
textarea.form-control {
    resize: vertical;
    min-height: 80px;
}

/* Estilos para input file */
input[type="file"].form-control {
    padding: 8px;
}

input[type="file"].form-control::file-selector-button {
    background-color: #0d6efd;
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 3px;
    margin-right: 10px;
    cursor: pointer;
}

input[type="file"].form-control::file-selector-button:hover {
    background-color: #0b5ed7;
}

/* Estilos para checkboxes */
.form-check-input {
    background-color: #1a1a1a;
    border: 1px solid #333;
    margin-right: 8px;
}

.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.form-check-input:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.form-check-label {
    cursor: pointer;
    user-select: none;
}

.form-check-label:hover {
    color: #87ceeb !important;
}

/* Animación para mostrar/ocultar campos */
.campo-animado {
    transition: all 0.3s ease-in-out;
    overflow: hidden;
}

.form-label {
    font-size: 0.9rem;
    margin-bottom: 5px;
}

.btn {
    padding: 10px 20px;
    border-radius: 4px;
    font-weight: 500;
}

.btn-primary {
    background-color: #0d6efd;
    border: none;
}

.btn-primary:hover {
    background-color: #0b5ed7;
}
</style>

<script>
// Variables desde Django
const usuarioAutenticadoId = JSON.parse(document.getElementById('user-id').textContent);

// Variables para cálculos de moneda
let monedasData = {};
let balanceActual = 0;

// Cargar datos de monedas y balance
function cargarDatosCalculos() {
    try {
        const monedasDataElement = document.getElementById('monedas-data');
        const userBalanceElement = document.getElementById('user-balance');
        
        if (monedasDataElement) {
            monedasData = JSON.parse(monedasDataElement.textContent);
        }
        
        if (userBalanceElement) {
            balanceActual = parseFloat(userBalanceElement.textContent) || 0;
        }
    } catch (e) {
        console.error('Error cargando datos para cálculos:', e);
        monedasData = {};
        balanceActual = 0;
    }
}

// Función para obtener datos de una moneda por ID
function obtenerValorMoneda(monedaId) {
    for (let moneda of monedasData) {
        if (moneda.id == monedaId) {
            return moneda;
        }
    }
    return null;
}

// Función para calcular y mostrar el monto en USD
function calcularMontoUSD() {
    const importeInput = document.getElementById('importe');
    const monedaSelect = document.getElementById('moneda');
    
    if (importeInput && monedaSelect) {
        const importe = parseFloat(importeInput.value) || 0;
        const monedaId = monedaSelect.value;
        
        if (importe > 0 && monedaId) {
            const moneda = obtenerValorMoneda(monedaId);
            console.log('Moneda encontrada:', moneda); // Debug
            
            if (moneda && moneda.valor_actual) {
                let montoUSD = importe;
                
                // Verificar que valor_actual es un número válido
                const valorActual = parseFloat(moneda.valor_actual);
                console.log('Valor actual de la moneda:', valorActual); // Debug
                
                if (moneda.codigo !== 'USD' && valorActual > 0) {
                    montoUSD = importe / valorActual;
                }
                
                // Verificar que montoUSD es un número válido
                if (!isNaN(montoUSD) && isFinite(montoUSD)) {
                    // Mostrar el cálculo
                    let calculoDiv = document.getElementById('calculo-usd-remesa');
                    if (!calculoDiv) {
                        calculoDiv = document.createElement('div');
                        calculoDiv.id = 'calculo-usd-remesa';
                        calculoDiv.className = 'alert alert-info mt-2';
                        importeInput.parentNode.appendChild(calculoDiv);
                    }
                    
                    const balanceDespues = balanceActual + montoUSD;
                    
                    let mensaje = '<strong>Monto en USD:</strong> $' + montoUSD.toFixed(2) + ' USD<br>';
                    mensaje += '<strong>Balance después de recibir:</strong> $' + balanceDespues.toFixed(2) + ' USD';
                    
                    calculoDiv.className = 'alert alert-success mt-2';
                    calculoDiv.innerHTML = mensaje;
                } else {
                    console.error('Error en el cálculo: montoUSD no es válido', montoUSD);
                }
            } else {
                console.error('Moneda no encontrada o sin valor_actual válido:', moneda);
            }
        } else {
            const calculoDiv = document.getElementById('calculo-usd-remesa');
            if (calculoDiv) {
                calculoDiv.remove();
            }
        }
    }
}

// Configurar listeners para recalcular automáticamente
function configurarCalculosRemesa() {
    const importeInput = document.getElementById('importe');
    const monedaSelect = document.getElementById('moneda');
    
    if (importeInput) {
        importeInput.addEventListener('input', function() {
            const value = parseFloat(this.value);
            if (isNaN(value) || value <= 0) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
            calcularMontoUSD();
        });
    }
    
    if (monedaSelect) {
        monedaSelect.addEventListener('change', calcularMontoUSD);
    }
}

function generarIdYFecha() {
    // Establecer fecha actual
    const fechaInput = document.getElementById('fecha');
    const hoy = new Date().toISOString().split('T')[0];
    fechaInput.value = hoy;
    
    // Generar ID de remesa
    const remesaIdInput = document.getElementById('remesa_id');
    const año = new Date().getFullYear();
    const numeroAleatorio = Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
    remesaIdInput.value = `REM-${año}-${numeroAleatorio}`;
}

document.addEventListener('DOMContentLoaded', function() {
    // Cargar datos para cálculos
    cargarDatosCalculos();
    
    // Inicializar fecha e ID
    generarIdYFecha();
    
    // Cargar datos dinámicos
    cargarMonedas();
    cargarGestores();
    cargarMetodosPago();
    
    // Configurar cálculos de USD
    configurarCalculosRemesa();
    
    // Configurar el formulario
    const form = document.getElementById('formRemesa');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        enviarRemesa();
    });
    
    // Configurar checkboxes para mostrar/ocultar campos opcionales
    configurarCamposOpcionales();
});

function configurarCamposOpcionales() {
    // Checkbox para observaciones
    const checkObservaciones = document.getElementById('check_observaciones');
    const campoObservaciones = document.getElementById('campo_observaciones');
    const textareaObservaciones = document.getElementById('observaciones');
    
    checkObservaciones.addEventListener('change', function() {
        if (this.checked) {
            campoObservaciones.style.display = 'block';
            campoObservaciones.classList.add('campo-animado');
            textareaObservaciones.focus();
        } else {
            campoObservaciones.style.display = 'none';
            textareaObservaciones.value = ''; // Limpiar el contenido cuando se oculta
        }
    });
    
    // Checkbox para comprobante
    const checkComprobante = document.getElementById('check_comprobante');
    const campoComprobante = document.getElementById('campo_comprobante');
    const inputComprobante = document.getElementById('comprobante');
    
    checkComprobante.addEventListener('change', function() {
        if (this.checked) {
            campoComprobante.style.display = 'block';
            campoComprobante.classList.add('campo-animado');
        } else {
            campoComprobante.style.display = 'none';
            inputComprobante.value = ''; // Limpiar el archivo cuando se oculta
        }
    });
}


function cargarMonedas() {
    // Cargar monedas desde el servidor
    fetch('/remesas/api/monedas/')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('moneda');
            // Limpiar opciones existentes excepto la primera
            select.innerHTML = '<option value="">Seleccionar moneda...</option>';
            
            // Actualizar datos de monedas para cálculos
            monedasData = data;
            console.log('Monedas cargadas:', monedasData); // Debug
            
            data.forEach(moneda => {
                const option = document.createElement('option');
                option.value = moneda.id;
                option.textContent = moneda.nombre;
                select.appendChild(option);
            });
            
            // Recalcular si hay valores
            calcularMontoUSD();
        })
        .catch(error => {
            console.error('Error cargando monedas:', error);
            // Si hay error, usar los datos del script inicial
            const monedasDataElement = document.getElementById('monedas-data');
            if (monedasDataElement) {
                try {
                    monedasData = JSON.parse(monedasDataElement.textContent);
                    console.log('Usando monedas del script inicial:', monedasData);
                    
                    const select = document.getElementById('moneda');
                    select.innerHTML = '<option value="">Seleccionar moneda...</option>';
                    
                    monedasData.forEach(moneda => {
                        const option = document.createElement('option');
                        option.value = moneda.id;
                        option.textContent = moneda.nombre;
                        select.appendChild(option);
                    });
                } catch (e) {
                    console.error('Error procesando datos de monedas:', e);
                }
            }
        });
}

function cargarGestores() {
    // Cargar gestores desde el servidor
    fetch('/remesas/api/gestores/')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('gestor');
            // Limpiar opciones existentes excepto la primera
            select.innerHTML = '<option value="">Seleccionar gestor...</option>';
            
            data.forEach(gestor => {
                const option = document.createElement('option');
                option.value = gestor.id;
                option.textContent = gestor.nombre;
                
                // Preseleccionar el usuario autenticado si existe
                if (usuarioAutenticadoId && gestor.id == usuarioAutenticadoId) {
                    option.selected = true;
                }
                
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error cargando gestores:', error);
        });
}

function cargarMetodosPago() {
    // Cargar métodos de pago desde el servidor
    fetch('/remesas/api/metodos-pago/')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('metodo_pago');
            // Limpiar opciones existentes excepto la primera
            select.innerHTML = '<option value="">Seleccionar método...</option>';
            
            data.forEach(metodo => {
                const option = document.createElement('option');
                option.value = metodo.id;
                option.textContent = metodo.nombre;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error cargando métodos de pago:', error);
        });
}

function limpiarFormulario() {
    if (confirm('¿Está seguro que desea limpiar el formulario?')) {
        document.getElementById('formRemesa').reset();
        generarIdYFecha();
        
        // Resetear checkboxes y ocultar campos opcionales
        document.getElementById('check_observaciones').checked = false;
        document.getElementById('check_comprobante').checked = false;
        document.getElementById('campo_observaciones').style.display = 'none';
        document.getElementById('campo_comprobante').style.display = 'none';
        
        // Eliminar cálculo de USD
        const calculoDiv = document.getElementById('calculo-usd-remesa');
        if (calculoDiv) {
            calculoDiv.remove();
        }
        
        // Recargar los selects para restablecer valores por defecto
        cargarMonedas();
        cargarGestores();
        cargarMetodosPago();
    }
}

function enviarRemesa() {
    console.log('Función enviarRemesa llamada');
    
    // Referencias a elementos del botón
    const boton = document.getElementById('btnGuardarRemesa');
    const icono = document.getElementById('btnIcono');
    const texto = document.getElementById('btnTexto');
    
    // Función para cambiar estado del botón
    function cambiarEstadoBoton(estado, textoBoton, iconoClass) {
        boton.disabled = estado === 'loading';
        texto.textContent = textoBoton;
        icono.className = iconoClass;
        
        if (estado === 'loading') {
            boton.classList.add('btn-warning');
            boton.classList.remove('btn-success', 'btn-danger');
        } else if (estado === 'success') {
            boton.classList.add('btn-success');
            boton.classList.remove('btn-warning', 'btn-danger');
        } else if (estado === 'error') {
            boton.classList.add('btn-danger');
            boton.classList.remove('btn-success', 'btn-warning');
            setTimeout(() => {
                cambiarEstadoBoton('normal', 'Guardar Remesa', 'fas fa-save me-2');
            }, 3000);
        } else {
            boton.classList.add('btn-success');
            boton.classList.remove('btn-warning', 'btn-danger');
        }
    }
    
    // Cambiar botón a estado de carga
    cambiarEstadoBoton('loading', 'Guardando...', 'fas fa-spinner fa-spin me-2');
    
    // Usar FormData directamente del formulario completo
    const form = document.getElementById('formRemesa');
    const formData = new FormData(form);
    
    // Validación básica de campos obligatorios
    const receptorNombre = formData.get('receptor_nombre');
    const importe = formData.get('importe');
    
    // Validación básica
    if (!receptorNombre || !receptorNombre.trim()) {
        cambiarEstadoBoton('error', 'Error: Falta remitente', 'fas fa-exclamation-triangle me-2');
        Swal.fire({ title: 'Error', text: 'El nombre del remitente es obligatorio', icon: 'error' });
        return;
    }
    if (!importe || parseFloat(importe) <= 0) {
        cambiarEstadoBoton('error', 'Error: Importe inválido', 'fas fa-exclamation-triangle me-2');
        Swal.fire({ title: 'Error', text: 'El importe es obligatorio y debe ser mayor a 0', icon: 'error' });
        return;
    }
    
    // Obtener CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    
    // Enviar datos al servidor
    fetch(window.location.href, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken ? csrfToken.value : '',
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`Error del servidor (${response.status}): ${text}`);
            });
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            return response.text().then(text => {
                throw new Error('La respuesta del servidor no es JSON válido');
            });
        }
        
        return response.json();
    })
    .then(result => {
        if (result.success) {
            cambiarEstadoBoton('success', '¡Guardado!', 'fas fa-check me-2');
            
            Swal.fire({
                title: '¡Éxito!',
                text: result.message,
                icon: 'success',
                showCancelButton: true,
                confirmButtonText: 'Ver Detalle',
                cancelButtonText: 'Nueva Remesa',
                confirmButtonColor: '#198754',
                background: '#212529',
                color: '#fff'
            }).then((swalResult) => {
                if (swalResult.isConfirmed) {
                    if (result.detalle_url) {
                        window.location.href = result.detalle_url;
                    } else {
                        window.location.href = `/remesas/detalle/${result.remesa_pk}/`;
                    }
                } else {
                    form.reset();
                    generarIdYFecha();
                    
                    // Resetear checkboxes y ocultar campos opcionales
                    document.getElementById('check_observaciones').checked = false;
                    document.getElementById('check_comprobante').checked = false;
                    document.getElementById('campo_observaciones').style.display = 'none';
                    document.getElementById('campo_comprobante').style.display = 'none';
                    
                    // Eliminar cálculo de USD
                    const calculoDiv = document.getElementById('calculo-usd-remesa');
                    if (calculoDiv) {
                        calculoDiv.remove();
                    }
                    
                    cambiarEstadoBoton('normal', 'Guardar Remesa', 'fas fa-save me-2');
                }
            });
        } else {
            cambiarEstadoBoton('error', 'Error del servidor', 'fas fa-exclamation-triangle me-2');
            Swal.fire({
                title: 'Error',
                text: result.message,
                icon: 'error',
                confirmButtonText: 'OK',
                background: '#212529',
                color: '#fff'
            });
        }
    })
    .catch(error => {
        console.error('Error en fetch:', error);
        cambiarEstadoBoton('error', 'Error de conexión', 'fas fa-exclamation-triangle me-2');
        
        let errorMessage = 'Error de conexión con el servidor';
        if (error.name === 'SyntaxError') {
            errorMessage = 'Error procesando respuesta del servidor';
        } else if (error.message) {
            errorMessage = error.message;
        }
        
        Swal.fire({
            title: 'Error',
            text: errorMessage,
            icon: 'error',
            confirmButtonText: 'OK',
            background: '#212529',
            color: '#fff'
        });
    });
}
</script>

{% endblock %}
